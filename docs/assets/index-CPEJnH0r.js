(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(s){if(s.ep)return;s.ep=!0;const c=n(s);fetch(s.href,c)}})();const P=document.getElementById("punchBtn"),pe=document.getElementById("todayCount"),fe=document.getElementById("streakCount"),W=document.getElementById("lastPunchTime"),O=document.getElementById("historyList"),Y=document.querySelectorAll(".filter-tab"),he=document.getElementById("exportBtn"),ye=document.getElementById("clearBtn"),G=document.querySelectorAll(".type-tab"),z=document.querySelectorAll(".history-type-tab"),R=document.getElementById("confirmModal"),ge=document.getElementById("modalTitle"),ve=document.getElementById("modalMessage"),Q=document.getElementById("modalCancel"),X=document.getElementById("modalConfirm"),ne="punch_records_v1",oe="punch_period_records_v1",U="punch_theme_v1",se="punch_achievements_v1",re=[{id:"streak7",title:"è¿ç»­ 7 å¤©",desc:"è¿ç»­æ‰“å¡æ»¡ 7 å¤©",icon:"ğŸ”¥",check:e=>ce(e)>=7},{id:"toilet30",title:"å¦‚å•è¾¾äºº",desc:"å¦‚å•æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš½",check:e=>_(e,"toilet").length>=30},{id:"meal30",title:"é¥­å¦è¾¾äºº",desc:"é¥­å¦æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš",check:e=>_(e,"meal").length>=30},{id:"fitness30",title:"å¥èº«è¾¾äºº",desc:"å¥èº«æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸ’ª",check:e=>_(e,"fitness").length>=30},{id:"days100",title:"åšæŒ 100 å¤©",desc:"ä½¿ç”¨æ‰“å¡æ»¡ 100 å¤©",icon:"ğŸ“…",check:e=>{if(!e.length)return!1;const t=e.slice().sort((o,s)=>o.timestamp-s.timestamp)[0];return Math.floor((Date.now()-t.timestamp)/(24*60*60*1e3))>=100}},{id:"all4",title:"å…¨èƒ½æ—¥",desc:"åŒä¸€å¤©æ‰“è¿‡å…¨éƒ¨ 4 ç§ç±»å‹",icon:"ğŸŒŸ",check:e=>V(e).some(({recs:n})=>new Set(n.map(s=>s.type||"other")).size>=4)}];function Ee(){try{const e=localStorage.getItem(ne);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load records",e),[]}}function F(e){localStorage.setItem(ne,JSON.stringify(e))}function w(e){return e.toISOString().slice(0,10)}function V(e){const t=new Map;return e.forEach(n=>{t.has(n.dateKey)||t.set(n.dateKey,[]),t.get(n.dateKey).push(n)}),Array.from(t.entries()).sort((n,o)=>n[0]<o[0]?1:-1).map(([n,o])=>({dateKey:n,recs:o}))}function N(e){const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return`${t}:${n}:${o}`}function T(e){const[t,n,o]=e.split("-");return`${t}å¹´${Number(n)}æœˆ${Number(o)}æ—¥`}function ie(e){const t=[];let n=0;for(;n<e.length;)if(e[n]==='"'){let o="";for(n++;n<e.length&&(e[n]!=='"'||e[n+1]==='"');)o+=e[n]==='"'&&e[n+1]==='"'?'"':e[n],n++;e[n]==='"'&&n++,t.push(o),e[n]===","&&n++}else{const o=e.indexOf(",",n),s=o===-1?e.slice(n):e.slice(n,o);t.push(s.trim()),n=o===-1?e.length:o+1}return t}function Le(e){return{å¦‚å•:"toilet",é¥­å¦:"meal",å¥èº«:"fitness",å…¶ä»–:"other"}[e]||"other"}function De(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);if(!t)return null;const[,n,o,s]=t,c=`${n}-${String(o).padStart(2,"0")}-${String(s).padStart(2,"0")}`,i=/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/.exec(e),u=i?parseInt(i[1],10):12,h=i?parseInt(i[2],10):0,m=i&&i[3]?parseInt(i[3],10):0,p=new Date(parseInt(n,10),parseInt(o,10)-1,parseInt(s,10),u,h,m);return{dateKey:c,timestamp:p.getTime()}}function Z(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);return t?`${t[1]}-${String(t[2]).padStart(2,"0")}-${String(t[3]).padStart(2,"0")}`:null}function Be(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=ie(t[o]);if(s.length<2)continue;const c=s[0].trim(),i=s[1].trim();if(o===0&&(c==="ç±»å‹"||c==="æ—¥æœŸæ—¶é—´"))continue;const u=Le(c),h=De(i);h&&n.push({id:`import-${h.timestamp}-${Math.random().toString(36).slice(2,6)}`,timestamp:h.timestamp,dateKey:h.dateKey,type:u})}return n}function Se(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=ie(t[o]);if(s.length<2)continue;const c=s[0].trim(),i=s[1].trim();if(o===0&&(c==="å¼€å§‹æ—¥æœŸ"||i==="ç»“æŸæ—¥æœŸ"))continue;const u=Z(c);if(!u)continue;const h=i==="è¿›è¡Œä¸­"||!i?null:Z(i);n.push({id:`p-import-${Date.now()}-${o}-${Math.random().toString(36).slice(2,6)}`,startDate:u,endDate:h||null})}return n}function be(e){const t=w(new Date);return e.filter(n=>n.dateKey===t).length}function ce(e){if(!e.length)return 0;const t=V(e);let n=0,o=new Date,s=w(o);for(let c=0;c<t.length;c++){const{dateKey:i}=t[c];if(i===s)n++,o.setDate(o.getDate()-1),s=w(o);else break}return n}function j(e){switch(e){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function ae(){try{const e=localStorage.getItem(U);if(e&&/^#[0-9A-Fa-f]{6}$/.test(e))return e}catch(e){console.error("Failed to load theme",e)}return null}function ee(e){e?localStorage.setItem(U,e):localStorage.removeItem(U)}function de(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function Ie(e,t){const{r:n,g:o,b:s}=de(e);return"#"+[n,o,s].map(c=>Math.round(Math.max(0,c*(1-t))).toString(16).padStart(2,"0")).join("")}function le(e){const t=document.documentElement;t.classList.forEach(c=>{c.startsWith("theme-day-")&&t.classList.remove(c)}),t.style.setProperty("--primary",e),t.style.setProperty("--primary-dark",Ie(e,.15));const{r:n,g:o,b:s}=de(e);t.style.setProperty("--primary-soft",`rgba(${n}, ${o}, ${s}, 0.15)`)}function me(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-dark"),e.style.removeProperty("--primary-soft"),e.classList.forEach(n=>{n.startsWith("theme-day-")&&e.classList.remove(n)});const t=new Date().getDay();e.classList.add("theme-day-"+t)}function Ce(){const e=ae();e?le(e):me()}function J(){try{const e=localStorage.getItem(se);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Te(e){localStorage.setItem(se,JSON.stringify(e))}function te(e){const t=J(),n=[];return re.forEach(o=>{t.includes(o.id)||o.check(e)&&(n.push(o),t.push(o.id))}),n.length&&Te(t),n}function we(e){const t=document.getElementById("achievementToast");if(!t)return;const n=t.querySelector(".achievement-toast-title"),o=t.querySelector(".achievement-toast-icon");n&&(n.textContent="æ­å–œï¼"+e.title),o&&(o.textContent=e.icon),t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),2500)}function Me(e,t,n){const o=`${t}-${String(n).padStart(2,"0")}`,s={};return e.forEach(c=>{c.dateKey.startsWith(o)&&(s[c.dateKey]=(s[c.dateKey]||0)+1)}),s}function ke(e,t){if(!e)return;const n=new Date,o=n.getFullYear(),s=n.getMonth()+1,c=Me(t,o,s),i=new Date(o,s-1,1),h=new Date(o,s-1+1,0).getDate(),m=i.getDay();let p='<div class="heatmap-grid">';["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(g=>{p+='<span class="heatmap-week-label">'+g+"</span>"});for(let g=0;g<m;g++)p+='<span class="heatmap-cell heatmap-cell-empty"></span>';for(let g=1;g<=h;g++){const v=`${o}-${String(s).padStart(2,"0")}-${String(g).padStart(2,"0")}`,C=c[v]||0;let b="heatmap-cell-0";C>=6?b="heatmap-cell-4":C>=4?b="heatmap-cell-3":C>=2?b="heatmap-cell-2":C>=1&&(b="heatmap-cell-1");const f=C?`${v} æ‰“å¡ ${C} æ¬¡`:v;p+='<span class="heatmap-cell '+b+'" title="'+f+'">'+(C||"")+"</span>"}p+="</div>",e.innerHTML=p}function $e(e){switch(e){case"toilet":return"ç§‹ç‘¾åˆæ‹‰ç²‘ç²‘å•¦ï½";case"meal":return"ç§‹ç‘¾çœŸä¹–ï¼Œåƒé¥­é¦™é¦™ï½";case"fitness":return"ç§‹ç‘¾å¨æ­¦ï¼ŒèŒå£®æˆé•¿ï½";default:return"ç§‹ç‘¾çœŸæ£’ï½"}}function Re(e){if(!e)return;e.innerHTML="";const t=["â™¥","âœ¨","â˜…","â˜†","â€¢","â™¥","âœ¨","â˜…"],n=["celebrate-float","celebrate-twinkle","celebrate-rise"],o=["#ff6b9d","#e84c7a","#ffd700","#ffb347","#c2185b","#f8bbd9"],s=28;for(let c=0;c<s;c++){const i=document.createElement("span");i.className="celebrate-item "+n[c%n.length],i.textContent=t[c%t.length],i.style.left=Math.random()*80+10+"%",i.style.top=Math.random()*80+10+"%",i.style.animationDelay=Math.random()*.8+"s",i.style.color=o[c%o.length],i.style.fontSize=12+Math.random()*12+"px",e.appendChild(i)}}function Ae(e,t){const n=new Date,o=w(n);if(t==="today")return e.filter(s=>s.dateKey===o);if(t==="week"){const s=new Date;s.setDate(n.getDate()-6);const c=w(s);return e.filter(i=>i.dateKey>=c)}if(t==="month"){const[s,c]=o.split("-"),i=`${s}-${c}`;return e.filter(u=>u.dateKey.startsWith(i))}return e}function M(e,t="all"){if(pe.textContent=String(be(e)),fe.textContent=String(ce(e)),!e.length)W.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const u=e[e.length-1],h=new Date(u.timestamp);W.textContent=`æœ€åä¸€æ¬¡ï¼š${T(u.dateKey)} ${N(h)}`}const n=Ae(e,t);if(O.innerHTML="",!n.length){O.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const o=document.createDocumentFragment(),s=r.historyType||"all";["toilet","meal","fitness","other"].forEach(u=>{if(s!=="all"&&s!==u)return;const h=n.filter(b=>(b.type||"other")===u);if(!h.length)return;const m=document.createElement("div");m.className=`history-type-block history-type-block-${u}`;const p=document.createElement("div");p.className="history-item";const B=document.createElement("div"),g=document.createElement("div");g.className="history-date",g.textContent=j(u);const v=document.createElement("div");v.className="history-time",v.textContent=`å…± ${h.length} æ¬¡`,B.appendChild(g),B.appendChild(v),p.appendChild(B),m.appendChild(p),V(h.slice().sort((b,f)=>b.timestamp-f.timestamp)).forEach(({dateKey:b,recs:f})=>{const E=document.createElement("div");E.className="history-item";const a=document.createElement("div"),l=document.createElement("div");l.className="history-date",l.textContent=T(b);const d=document.createElement("div");d.className="history-time-list",f.forEach(y=>{const I=new Date(y.timestamp),L=document.createElement("div");L.className="time-chip";const D=document.createElement("span");D.textContent=N(I);const S=document.createElement("button");S.className="time-delete-btn",S.textContent="åˆ ",S.setAttribute("data-id",y.id),L.appendChild(D),L.appendChild(S),d.appendChild(L)}),a.appendChild(l),a.appendChild(d),E.appendChild(a),m.appendChild(E)}),o.appendChild(m)}),O.appendChild(o),ke(document.getElementById("heatmapContainer"),r.records);const i=document.getElementById("achievementCount");i&&(i.textContent=String(J().length))}let r={records:[],filter:"all",currentType:"fitness",historyType:"all",periodRecords:[],activeTab:"punch"},K=null;function x(e){const{title:t,message:n,onConfirm:o}=e;if(!R){window.confirm(n)&&typeof o=="function"&&o();return}ge.textContent=t||"ç¡®è®¤æ“ä½œ",ve.textContent=n||"",K=typeof o=="function"?o:null,R.hidden=!1}function H(){R&&(R.hidden=!0),K=null}function _(e,t){return t?e.filter(n=>(n.type||"other")===t):e}function xe(){try{const e=localStorage.getItem(oe);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load period records",e),[]}}function A(e){localStorage.setItem(oe,JSON.stringify(e))}function q(e){return e.filter(t=>!t.endDate).sort((t,n)=>n.startDate>t.startDate?1:-1)[0]||null}function Ke(e){const t=e.map(i=>i.startDate).filter(Boolean).sort();if(t.length<2)return null;const n=[];for(let i=1;i<t.length;i++){const u=new Date(t[i-1]),h=new Date(t[i]),m=Math.round((h-u)/(24*60*60*1e3));m>0&&m<90&&n.push(m)}if(!n.length)return null;const o=Math.round(n.reduce((i,u)=>i+u,0)/n.length),s=t[t.length-1],c=new Date(s);return c.setDate(c.getDate()+o),{dateKey:w(c),avgCycle:o}}function k(){const e=document.getElementById("periodStatus"),t=document.getElementById("periodPrediction"),n=document.getElementById("periodHistoryList"),o=document.getElementById("periodStartBtn"),s=document.getElementById("periodEndBtn");if(!e||!t||!n)return;const c=r.periodRecords,i=q(c);w(new Date),i?(e.innerHTML=`
      <div class="period-status-title">è¿›è¡Œä¸­</div>
      <div>å¼€å§‹ï¼š${T(i.startDate)}</div>
      <div>ç»“æŸï¼šå°šæœªè®°å½•</div>
    `,s&&(s.disabled=!1),o&&(o.disabled=!0)):(e.innerHTML=`
      <div class="period-status-title">æœªåœ¨ç»æœŸ</div>
      <div>è®°å½•ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€å¼€å§‹æ–°å‘¨æœŸ</div>
    `,s&&(s.disabled=!0),o&&(o.disabled=!1));const u=Ke(c);u?(t.innerHTML=`
      <div class="period-prediction-title">é¢„è®¡ä¸‹æ¬¡å¼€å§‹</div>
      <div class="period-prediction-value">${T(u.dateKey)}</div>
      <div class="period-prediction-hint">åŸºäºå¹³å‡å‘¨æœŸ ${u.avgCycle} å¤©ï¼Œä»…ä¾›å‚è€ƒ</div>
    `,t.hidden=!1):(t.innerHTML=`
      <div class="period-prediction-title">é¢„æµ‹</div>
      <div class="period-prediction-hint">å†è®°å½•è‡³å°‘ 2 æ¬¡ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€åä¼šæ˜¾ç¤ºé¢„æµ‹</div>
    `,t.hidden=!1);const h=[...c].sort((m,p)=>p.startDate>m.startDate?1:-1);if(!h.length){n.innerHTML='<div class="period-empty">æš‚æ— ç»æœŸè®°å½•</div>';return}n.innerHTML="",h.forEach(m=>{const p=document.createElement("div");p.className="period-history-item";const B=m.endDate?`${T(m.startDate)} ï½ ${T(m.endDate)}`:`${T(m.startDate)} ï½ è¿›è¡Œä¸­`,g=m.endDate?Math.round((new Date(m.endDate)-new Date(m.startDate))/(24*60*60*1e3))+1:"";p.innerHTML=`
      <span class="period-range">${B}</span>
      <span class="period-days">${g?g+" å¤©":""}</span>
      <button type="button" class="period-history-delete" data-period-id="${m.id}">åˆ </button>
    `,n.appendChild(p)})}function Pe(){r.records=Ee(),r.periodRecords=xe(),G.forEach(a=>{a.addEventListener("click",()=>{G.forEach(l=>l.classList.remove("active")),a.classList.add("active"),r.currentType=a.dataset.type||"fitness",M(r.records,r.filter)})});const e=document.querySelector(".type-tab.active");e&&(r.currentType=e.dataset.type||"fitness"),M(r.records,r.filter),te(r.records);const t=document.getElementById("punchSuccessModal"),n=document.getElementById("punchSuccessMessage"),o=document.getElementById("punchSuccessCelebration"),s=document.getElementById("punchSuccessConfirm");P.addEventListener("click",()=>{const a=new Date,l={id:`${a.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:a.getTime(),dateKey:w(a),type:r.currentType};r.records.push(l),F(r.records),t&&n&&(n.textContent=$e(r.currentType),t.hidden=!1,requestAnimationFrame(()=>Re(o))),P.classList.remove("punch-button-bounce"),P.offsetWidth,P.classList.add("punch-button-bounce"),setTimeout(()=>{M(r.records,r.filter),te(r.records).forEach(d=>we(d))},0)}),s&&t&&s.addEventListener("click",()=>{t.hidden=!0}),t&&t.addEventListener("click",a=>{a.target===t&&(t.hidden=!0)});const c=document.getElementById("achievementBtn"),i=document.getElementById("achievementModal");c&&i&&c.addEventListener("click",()=>{const a=document.getElementById("achievementList");if(a){const l=J();a.innerHTML=re.map(d=>'<div class="achievement-item '+(l.includes(d.id)?"unlocked":"locked")+'"><span class="achievement-icon">'+d.icon+'</span><div class="achievement-info"><span class="achievement-title">'+d.title+'</span><span class="achievement-desc">'+d.desc+"</span></div></div>").join("")}i.hidden=!1});const u=document.getElementById("achievementModalClose");u&&i&&u.addEventListener("click",()=>{i.hidden=!0}),i&&i.addEventListener("click",a=>{a.target===i&&(i.hidden=!0)}),Y.forEach(a=>{a.addEventListener("click",()=>{Y.forEach(l=>l.classList.remove("active")),a.classList.add("active"),r.filter=a.dataset.filter||"all",M(r.records,r.filter)})}),z.forEach(a=>{a.addEventListener("click",()=>{z.forEach(l=>l.classList.remove("active")),a.classList.add("active"),r.historyType=a.dataset.historyType||"all",M(r.records,r.filter)})}),Q&&Q.addEventListener("click",()=>{H()}),X&&X.addEventListener("click",()=>{if(K){const a=K;K=null,H(),a()}else H()}),R&&R.addEventListener("click",a=>{a.target===R&&H()}),O.addEventListener("click",a=>{const l=a.target;if(!(l instanceof HTMLElement)||!l.classList.contains("time-delete-btn"))return;const d=l.getAttribute("data-id");if(!d)return;const y=r.records.find(D=>D.id===d);if(!y)return;const I=j(y.type||"other"),L=new Date(y.timestamp);x({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${I}ã€‘åœ¨ã€${T(y.dateKey)} ${N(L)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{r.records=r.records.filter(D=>D.id!==d),F(r.records),M(r.records,r.filter)}})}),he.addEventListener("click",()=>{const a=document.getElementById("actionsMenu");if(a&&a.classList.contains("open")&&a.classList.remove("open"),!r.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const l=["ç±»å‹","æ—¥æœŸæ—¶é—´"],d=r.records.slice().sort((S,$)=>S.timestamp-$.timestamp).map(S=>{const $=new Date(S.timestamp),ue=`${T(S.dateKey)} ${N($)}`;return[j(S.type||"other"),ue]}),y=[l,...d].map(S=>S.map($=>`"${$}"`).join(",")).join(`
`),I=new Blob([y],{type:"text/csv;charset=utf-8;"}),L=URL.createObjectURL(I),D=document.createElement("a");D.href=L,D.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${w(new Date)}.csv`,D.click(),URL.revokeObjectURL(L)});const h=document.getElementById("importBtn"),m=document.getElementById("punchFileInput");h&&m&&(h.addEventListener("click",()=>{const a=document.getElementById("actionsMenu");a&&a.classList.contains("open")&&a.classList.remove("open"),m.value="",m.click()}),m.addEventListener("change",()=>{const a=m.files&&m.files[0];if(!a)return;const l=new FileReader;l.onload=()=>{try{let d=typeof l.result=="string"?l.result:"";d=d.replace(/^\uFEFF/,"");const y=Be(d);if(!y.length){alert("æœªè§£æåˆ°æœ‰æ•ˆæ‰“å¡æ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šç±»å‹ã€æ—¥æœŸæ—¶é—´");return}r.records=r.records.concat(y),r.records.sort((I,L)=>I.timestamp-L.timestamp),F(r.records),M(r.records,r.filter),alert("å·²å¯¼å…¥ "+y.length+" æ¡æ‰“å¡è®°å½•")}catch(d){alert("è§£æå¤±è´¥ï¼š"+(d.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ CSV"))}},l.readAsText(a,"UTF-8")})),ye.addEventListener("click",()=>{const a=document.getElementById("actionsMenu");a&&a.classList.contains("open")&&a.classList.remove("open"),r.records.length&&x({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{r.records=[],F(r.records),M(r.records,r.filter)}})});const p=document.getElementById("periodStartBtn");p&&p.addEventListener("click",()=>{const a=q(r.periodRecords),l=w(new Date);if(a){const d=new Date;d.setDate(d.getDate()-1);const y=w(d);x({title:"å¼€å§‹æ–°å‘¨æœŸ",message:"å½“å‰æœ‰ä¸€å‘¨æœŸæœªç»“æŸï¼Œå°†æŠŠä¸Šä¸€å‘¨æœŸç»“æŸæ—¥è®¾ä¸ºæ˜¨å¤©ï¼Œå†è®°å½•æœ¬æ¬¡å¼€å§‹ã€‚ç¡®å®šï¼Ÿ",onConfirm:()=>{a.endDate=y;const I={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:l,endDate:null};r.periodRecords.push(I),A(r.periodRecords),k()}})}else{const d={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:l,endDate:null};r.periodRecords.push(d),A(r.periodRecords),k()}});const B=document.getElementById("periodEndBtn");B&&B.addEventListener("click",()=>{const a=q(r.periodRecords);if(!a)return;const l=w(new Date);a.endDate=l,A(r.periodRecords),k()});const g=document.getElementById("periodHistoryList");g&&g.addEventListener("click",a=>{const l=a.target;if(!l.classList.contains("period-history-delete"))return;const d=l.getAttribute("data-period-id");if(!d)return;const y=r.periodRecords.find(L=>L.id===d);if(!y)return;const I=y.endDate?`${T(y.startDate)} ï½ ${T(y.endDate)}`:T(y.startDate)+" ï½ è¿›è¡Œä¸­";x({title:"åˆ é™¤ç»æœŸè®°å½•",message:`ç¡®å®šåˆ é™¤ã€Œ${I}ã€è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{r.periodRecords=r.periodRecords.filter(L=>L.id!==d),A(r.periodRecords),k()}})});const v=document.getElementById("periodActionsMenu"),C=document.getElementById("periodExportBtn");C&&C.addEventListener("click",()=>{if(!r.periodRecords.length){alert("æš‚æ— ç»æœŸæ•°æ®å¯å¯¼å‡º");return}const a=["å¼€å§‹æ—¥æœŸ","ç»“æŸæ—¥æœŸ","å¤©æ•°"],l=[...r.periodRecords].sort((D,S)=>S.startDate>D.startDate?1:-1).map(D=>{const S=D.endDate?T(D.endDate):"è¿›è¡Œä¸­",$=D.endDate?String(Math.round((new Date(D.endDate)-new Date(D.startDate))/(24*60*60*1e3))+1):"-";return[T(D.startDate),S,$]}),d=[a,...l].map(D=>D.map(S=>`"${S}"`).join(",")).join(`
`),y=new Blob([d],{type:"text/csv;charset=utf-8;"}),I=URL.createObjectURL(y),L=document.createElement("a");L.href=I,L.download=`ç»æœŸè®°å½•-${w(new Date)}.csv`,L.click(),URL.revokeObjectURL(I),v&&v.classList.remove("open")});const b=document.getElementById("periodClearBtn");b&&b.addEventListener("click",()=>{r.periodRecords.length&&(v&&v.classList.remove("open"),x({title:"æ¸…ç©ºç»æœŸè®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»æœŸè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{r.periodRecords=[],A(r.periodRecords),k()}}))});const f=document.getElementById("periodImportBtn"),E=document.getElementById("periodFileInput");f&&E&&(f.addEventListener("click",()=>{v&&v.classList.remove("open"),E.value="",E.click()}),E.addEventListener("change",()=>{const a=E.files&&E.files[0];if(!a)return;const l=new FileReader;l.onload=()=>{try{let d=typeof l.result=="string"?l.result:"";d=d.replace(/^\uFEFF/,"");const y=Se(d);if(!y.length){alert("æœªè§£æåˆ°æœ‰æ•ˆç»æœŸæ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸã€å¤©æ•°");return}r.periodRecords=r.periodRecords.concat(y),r.periodRecords.sort((I,L)=>L.startDate>I.startDate?1:-1),A(r.periodRecords),k(),alert("å·²å¯¼å…¥ "+y.length+" æ¡ç»æœŸè®°å½•")}catch(d){alert("è§£æå¤±è´¥ï¼š"+(d.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ç»æœŸ CSV"))}},l.readAsText(a,"UTF-8")}))}document.addEventListener("DOMContentLoaded",function(){Ce(),Pe(),k();var e=document.getElementById("themeBtn"),t=document.getElementById("themeModal"),n=document.getElementById("themeModalClose"),o=document.getElementById("themeColorInput"),s=document.getElementById("themeResetBtn"),c=document.getElementById("themeHelpBtn"),i=document.getElementById("themeHelpBlock");function u(){var f=ae();f?o.value=f:o.value=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim()||"#6B7FD7",i.hidden=!0,t.hidden=!1}function h(){t.hidden=!0}e&&e.addEventListener("click",u),n&&n.addEventListener("click",h),t&&t.addEventListener("click",function(f){f.target===t&&h()}),o&&o.addEventListener("input",function(){var f=o.value;ee(f),le(f)}),s&&s.addEventListener("click",function(){ee(null),me(),h()}),c&&i&&c.addEventListener("click",function(){i.hidden=!i.hidden});var m=document.getElementById("actionsFabToggle"),p=document.getElementById("actionsMenu"),B=document.getElementById("periodActionsMenu");m&&p&&B&&(m.addEventListener("click",function(){var f=r.activeTab==="punch"?p:B,E=r.activeTab==="punch"?B:p;E.classList.remove("open"),f.classList.toggle("open")}),document.addEventListener("click",function(f){m.contains(f.target)||p.contains(f.target)||B.contains(f.target)||(p.classList.contains("open")||B.classList.contains("open"))&&(p.classList.remove("open"),B.classList.remove("open"))}));var g=document.getElementById("panelPunch"),v=document.getElementById("panelPeriod"),C=document.querySelectorAll(".tab-bar-item");document.getElementById("actionsFab");function b(f){r.activeTab=f,p&&p.classList.contains("open")&&p.classList.remove("open"),B&&B.classList.contains("open")&&B.classList.remove("open"),f==="punch"?(g&&(g.classList.add("active"),g.removeAttribute("hidden")),v&&(v.classList.remove("active"),v.hidden=!0)):(g&&(g.classList.remove("active"),g.hidden=!0),v&&(v.classList.add("active"),v.removeAttribute("hidden")),k()),C.forEach(function(E){E.getAttribute("data-tab")===f?(E.classList.add("active"),E.setAttribute("aria-selected","true")):(E.classList.remove("active"),E.setAttribute("aria-selected","false"))})}C.forEach(function(f){f.addEventListener("click",function(){var E=f.getAttribute("data-tab");E&&b(E)})})});
