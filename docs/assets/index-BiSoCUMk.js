(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const N=document.getElementById("punchBtn"),ve=document.getElementById("todayCount"),Ee=document.getElementById("streakCount"),X=document.getElementById("lastPunchTime"),j=document.getElementById("historyList"),Z=document.querySelectorAll(".filter-tab"),Le=document.getElementById("exportBtn"),Be=document.getElementById("clearBtn"),ee=document.querySelectorAll(".type-tab"),te=document.querySelectorAll(".history-type-tab"),K=document.getElementById("confirmModal"),De=document.getElementById("modalTitle"),Ie=document.getElementById("modalMessage"),ne=document.getElementById("modalCancel"),oe=document.getElementById("modalConfirm"),ce="punch_records_v1",ae="punch_period_records_v1",J="punch_theme_v1",de="punch_achievements_v1",le=[{id:"streak7",title:"è¿ç»­ 7 å¤©",desc:"è¿ç»­æ‰“å¡æ»¡ 7 å¤©",icon:"ğŸ”¥",check:e=>me(e)>=7},{id:"toilet30",title:"å¦‚å•è¾¾äºº",desc:"å¦‚å•æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš½",check:e=>V(e,"toilet").length>=30},{id:"meal30",title:"é¥­å¦è¾¾äºº",desc:"é¥­å¦æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš",check:e=>V(e,"meal").length>=30},{id:"fitness30",title:"å¥èº«è¾¾äºº",desc:"å¥èº«æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸ’ª",check:e=>V(e,"fitness").length>=30},{id:"days100",title:"åšæŒ 100 å¤©",desc:"ä½¿ç”¨æ‰“å¡æ»¡ 100 å¤©",icon:"ğŸ“…",check:e=>{if(!e.length)return!1;const t=e.slice().sort((o,s)=>o.timestamp-s.timestamp)[0];return Math.floor((Date.now()-t.timestamp)/(24*60*60*1e3))>=100}},{id:"all4",title:"å…¨èƒ½æ—¥",desc:"åŒä¸€å¤©æ‰“è¿‡å…¨éƒ¨ 4 ç§ç±»å‹",icon:"ğŸŒŸ",check:e=>G(e).some(({recs:n})=>new Set(n.map(s=>s.type||"other")).size>=4)}];function be(){try{const e=localStorage.getItem(ce);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load records",e),[]}}function _(e){localStorage.setItem(ce,JSON.stringify(e))}function T(e){return e.toISOString().slice(0,10)}function G(e){const t=new Map;return e.forEach(n=>{t.has(n.dateKey)||t.set(n.dateKey,[]),t.get(n.dateKey).push(n)}),Array.from(t.entries()).sort((n,o)=>n[0]<o[0]?1:-1).map(([n,o])=>({dateKey:n,recs:o}))}function q(e){const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return`${t}:${n}:${o}`}function C(e){const[t,n,o]=e.split("-");return`${t}å¹´${Number(n)}æœˆ${Number(o)}æ—¥`}function ue(e){const t=[];let n=0;for(;n<e.length;)if(e[n]==='"'){let o="";for(n++;n<e.length&&(e[n]!=='"'||e[n+1]==='"');)o+=e[n]==='"'&&e[n+1]==='"'?'"':e[n],n++;e[n]==='"'&&n++,t.push(o),e[n]===","&&n++}else{const o=e.indexOf(",",n),s=o===-1?e.slice(n):e.slice(n,o);t.push(s.trim()),n=o===-1?e.length:o+1}return t}function Se(e){return{å¦‚å•:"toilet",é¥­å¦:"meal",å¥èº«:"fitness",å…¶ä»–:"other"}[e]||"other"}function Me(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);if(!t)return null;const[,n,o,s]=t,a=`${n}-${String(o).padStart(2,"0")}-${String(s).padStart(2,"0")}`,i=/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/.exec(e),p=i?parseInt(i[1],10):12,f=i?parseInt(i[2],10):0,u=i&&i[3]?parseInt(i[3],10):0,h=new Date(parseInt(n,10),parseInt(o,10)-1,parseInt(s,10),p,f,u);return{dateKey:a,timestamp:h.getTime()}}function se(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);return t?`${t[1]}-${String(t[2]).padStart(2,"0")}-${String(t[3]).padStart(2,"0")}`:null}function Ce(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=ue(t[o]);if(s.length<2)continue;const a=s[0].trim(),i=s[1].trim();if(o===0&&(a==="ç±»å‹"||a==="æ—¥æœŸæ—¶é—´"))continue;const p=Se(a),f=Me(i);f&&n.push({id:`import-${f.timestamp}-${Math.random().toString(36).slice(2,6)}`,timestamp:f.timestamp,dateKey:f.dateKey,type:p})}return n}function ke(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=ue(t[o]);if(s.length<2)continue;const a=s[0].trim(),i=s[1].trim();if(o===0&&(a==="å¼€å§‹æ—¥æœŸ"||i==="ç»“æŸæ—¥æœŸ"))continue;const p=se(a);if(!p)continue;const f=i==="è¿›è¡Œä¸­"||!i?null:se(i);n.push({id:`p-import-${Date.now()}-${o}-${Math.random().toString(36).slice(2,6)}`,startDate:p,endDate:f||null})}return n}function Te(e){const t=T(new Date);return e.filter(n=>n.dateKey===t).length}function me(e){if(!e.length)return 0;const t=G(e);let n=0,o=new Date,s=T(o);for(let a=0;a<t.length;a++){const{dateKey:i}=t[a];if(i===s)n++,o.setDate(o.getDate()-1),s=T(o);else break}return n}function W(e){switch(e){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function pe(){try{const e=localStorage.getItem(J);if(e&&/^#[0-9A-Fa-f]{6}$/.test(e))return e}catch(e){console.error("Failed to load theme",e)}return null}function re(e){e?localStorage.setItem(J,e):localStorage.removeItem(J)}function fe(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function we(e,t){const{r:n,g:o,b:s}=fe(e);return"#"+[n,o,s].map(a=>Math.round(Math.max(0,a*(1-t))).toString(16).padStart(2,"0")).join("")}function he(e){const t=document.documentElement;t.classList.forEach(a=>{a.startsWith("theme-day-")&&t.classList.remove(a)}),t.style.setProperty("--primary",e),t.style.setProperty("--primary-dark",we(e,.15));const{r:n,g:o,b:s}=fe(e);t.style.setProperty("--primary-soft",`rgba(${n}, ${o}, ${s}, 0.15)`)}function ye(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-dark"),e.style.removeProperty("--primary-soft"),e.classList.forEach(n=>{n.startsWith("theme-day-")&&e.classList.remove(n)});const t=new Date().getDay();e.classList.add("theme-day-"+t)}function $e(){const e=pe();e?he(e):ye()}function z(){try{const e=localStorage.getItem(de);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Ae(e){localStorage.setItem(de,JSON.stringify(e))}function ie(e){const t=z(),n=[];return le.forEach(o=>{t.includes(o.id)||o.check(e)&&(n.push(o),t.push(o.id))}),n.length&&Ae(t),n}function Re(e){const t=document.getElementById("achievementToast");if(!t)return;const n=t.querySelector(".achievement-toast-title"),o=t.querySelector(".achievement-toast-icon");n&&(n.textContent="æ­å–œï¼"+e.title),o&&(o.textContent=e.icon),t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),2500)}function xe(e,t,n){const o=`${t}-${String(n).padStart(2,"0")}`,s={};return e.forEach(a=>{a.dateKey.startsWith(o)&&(s[a.dateKey]=(s[a.dateKey]||0)+1)}),s}function Ke(e,t){if(!e)return;const n=new Date,o=n.getFullYear(),s=n.getMonth()+1,a=xe(t,o,s),i=new Date(o,s-1,1),f=new Date(o,s-1+1,0).getDate(),u=i.getDay();let h='<div class="heatmap-grid">';["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(B=>{h+='<span class="heatmap-week-label">'+B+"</span>"});for(let B=0;B<u;B++)h+='<span class="heatmap-cell heatmap-cell-empty"></span>';for(let B=1;B<=f;B++){const L=`${o}-${String(s).padStart(2,"0")}-${String(B).padStart(2,"0")}`,M=a[L]||0;let I="heatmap-cell-0";M>=6?I="heatmap-cell-4":M>=4?I="heatmap-cell-3":M>=2?I="heatmap-cell-2":M>=1&&(I="heatmap-cell-1");const S=M?`${L} æ‰“å¡ ${M} æ¬¡`:L;h+='<span class="heatmap-cell '+I+'" title="'+S+'">'+(M||"")+"</span>"}h+="</div>",e.innerHTML=h}function He(e){switch(e){case"toilet":return"ç§‹ç‘¾åˆæ‹‰ç²‘ç²‘å•¦ï½";case"meal":return"ç§‹ç‘¾çœŸä¹–ï¼Œåƒé¥­é¦™é¦™ï½";case"fitness":return"ç§‹ç‘¾å¨æ­¦ï¼ŒèŒå£®æˆé•¿ï½";default:return"ç§‹ç‘¾çœŸæ£’ï½"}}function Pe(e){if(!e)return;e.innerHTML="";const t=["â™¥","âœ¨","â˜…","â˜†","â€¢","â™¥","âœ¨","â˜…"],n=["celebrate-float","celebrate-twinkle","celebrate-rise"],o=["#ff6b9d","#e84c7a","#ffd700","#ffb347","#c2185b","#f8bbd9"],s=28;for(let a=0;a<s;a++){const i=document.createElement("span");i.className="celebrate-item "+n[a%n.length],i.textContent=t[a%t.length],i.style.left=Math.random()*80+10+"%",i.style.top=Math.random()*80+10+"%",i.style.animationDelay=Math.random()*.8+"s",i.style.color=o[a%o.length],i.style.fontSize=12+Math.random()*12+"px",e.appendChild(i)}}function Fe(e,t){const n=new Date,o=T(n);if(t==="today")return e.filter(s=>s.dateKey===o);if(t==="week"){const s=new Date;s.setDate(n.getDate()-6);const a=T(s);return e.filter(i=>i.dateKey>=a)}if(t==="month"){const[s,a]=o.split("-"),i=`${s}-${a}`;return e.filter(p=>p.dateKey.startsWith(i))}return e}function R(e,t="all"){if(ve.textContent=String(Te(e)),Ee.textContent=String(me(e)),!e.length)X.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const p=e[e.length-1],f=new Date(p.timestamp);X.textContent=`æœ€åä¸€æ¬¡ï¼š${C(p.dateKey)} ${q(f)}`}const n=Fe(e,t);if(j.innerHTML="",!n.length){j.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const o=document.createDocumentFragment(),s=r.historyType||"all";["toilet","meal","fitness","other"].forEach(p=>{if(s!=="all"&&s!==p)return;const f=n.filter(I=>(I.type||"other")===p);if(!f.length)return;const u=document.createElement("div");u.className=`history-type-block history-type-block-${p}`;const h=document.createElement("div");h.className="history-item";const w=document.createElement("div"),B=document.createElement("div");B.className="history-date",B.textContent=W(p);const L=document.createElement("div");L.className="history-time",L.textContent=`å…± ${f.length} æ¬¡`,w.appendChild(B),w.appendChild(L),h.appendChild(w),u.appendChild(h),G(f.slice().sort((I,S)=>I.timestamp-S.timestamp)).forEach(({dateKey:I,recs:S})=>{const k=document.createElement("div");k.className="history-item";const c=document.createElement("div"),d=document.createElement("div");d.className="history-date",d.textContent=C(I);const l=document.createElement("div");l.className="history-time-list",S.forEach(m=>{const D=new Date(m.timestamp),E=document.createElement("div");E.className="time-chip";const v=document.createElement("span");v.textContent=q(D);const y=document.createElement("button");y.className="time-delete-btn",y.textContent="åˆ ",y.setAttribute("data-id",m.id),E.appendChild(v),E.appendChild(y),l.appendChild(E)}),c.appendChild(d),c.appendChild(l),k.appendChild(c),u.appendChild(k)}),o.appendChild(u)}),j.appendChild(o),Ke(document.getElementById("heatmapContainer"),r.records);const i=document.getElementById("achievementCount");i&&(i.textContent=String(z().length))}let r={records:[],filter:"all",currentType:"fitness",historyType:"all",periodRecords:[],activeTab:"punch"},O=null;function F(e){const{title:t,message:n,onConfirm:o}=e;if(!K){window.confirm(n)&&typeof o=="function"&&o();return}De.textContent=t||"ç¡®è®¤æ“ä½œ",Ie.textContent=n||"",O=typeof o=="function"?o:null,K.hidden=!1}function U(){K&&(K.hidden=!0),O=null}function V(e,t){return t?e.filter(n=>(n.type||"other")===t):e}function Oe(){try{const e=localStorage.getItem(ae);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load period records",e),[]}}function P(e){localStorage.setItem(ae,JSON.stringify(e))}function Y(e){return e.filter(t=>!t.endDate).sort((t,n)=>n.startDate>t.startDate?1:-1)[0]||null}function Ne(e){const t=e.map(i=>i.startDate).filter(Boolean).sort();if(t.length<2)return null;const n=[];for(let i=1;i<t.length;i++){const p=new Date(t[i-1]),f=new Date(t[i]),u=Math.round((f-p)/(24*60*60*1e3));u>0&&u<90&&n.push(u)}if(!n.length)return null;const o=Math.round(n.reduce((i,p)=>i+p,0)/n.length),s=t[t.length-1],a=new Date(s);return a.setDate(a.getDate()+o),{dateKey:T(a),avgCycle:o}}function x(){const e=document.getElementById("periodStatus"),t=document.getElementById("periodPrediction"),n=document.getElementById("periodHistoryList"),o=document.getElementById("periodStartBtn"),s=document.getElementById("periodEndBtn");if(!e||!t||!n)return;const a=r.periodRecords,i=Y(a);T(new Date),i?(e.innerHTML=`
      <div class="period-status-title">è¿›è¡Œä¸­</div>
      <div>å¼€å§‹ï¼š${C(i.startDate)}</div>
      <div>ç»“æŸï¼šå°šæœªè®°å½•</div>
    `,s&&(s.disabled=!1),o&&(o.disabled=!0)):(e.innerHTML=`
      <div class="period-status-title">æœªåœ¨ç»æœŸ</div>
      <div>è®°å½•ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€å¼€å§‹æ–°å‘¨æœŸ</div>
    `,s&&(s.disabled=!0),o&&(o.disabled=!1));const p=Ne(a);p?(t.innerHTML=`
      <div class="period-prediction-title">é¢„è®¡ä¸‹æ¬¡å¼€å§‹</div>
      <div class="period-prediction-value">${C(p.dateKey)}</div>
      <div class="period-prediction-hint">åŸºäºå¹³å‡å‘¨æœŸ ${p.avgCycle} å¤©ï¼Œä»…ä¾›å‚è€ƒ</div>
    `,t.hidden=!1):(t.innerHTML=`
      <div class="period-prediction-title">é¢„æµ‹</div>
      <div class="period-prediction-hint">å†è®°å½•è‡³å°‘ 2 æ¬¡ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€åä¼šæ˜¾ç¤ºé¢„æµ‹</div>
    `,t.hidden=!1);const f=[...a].sort((u,h)=>h.startDate>u.startDate?1:-1);if(!f.length){n.innerHTML='<div class="period-empty">æš‚æ— ç»æœŸè®°å½•</div>';return}n.innerHTML="",f.forEach(u=>{const h=document.createElement("div");h.className="period-history-item";const w=u.endDate?`${C(u.startDate)} ï½ ${C(u.endDate)}`:`${C(u.startDate)} ï½ è¿›è¡Œä¸­`,B=u.endDate?Math.round((new Date(u.endDate)-new Date(u.startDate))/(24*60*60*1e3))+1:"";h.innerHTML=`
      <span class="period-range">${w}</span>
      <span class="period-days">${B?B+" å¤©":""}</span>
      <button type="button" class="period-history-delete" data-period-id="${u.id}">åˆ </button>
    `,n.appendChild(h)})}function _e(){r.records=be(),r.periodRecords=Oe(),ee.forEach(c=>{c.addEventListener("click",()=>{ee.forEach(d=>d.classList.remove("active")),c.classList.add("active"),r.currentType=c.dataset.type||"fitness",R(r.records,r.filter)})});const e=document.querySelector(".type-tab.active");e&&(r.currentType=e.dataset.type||"fitness"),R(r.records,r.filter),ie(r.records);const t=document.getElementById("punchSuccessModal"),n=document.getElementById("punchSuccessMessage"),o=document.getElementById("punchSuccessCelebration"),s=document.getElementById("punchSuccessConfirm");N.addEventListener("click",()=>{const c=new Date,d={id:`${c.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:c.getTime(),dateKey:T(c),type:r.currentType};r.records.push(d),_(r.records),t&&n&&(n.textContent=He(r.currentType),t.hidden=!1,requestAnimationFrame(()=>Pe(o))),N.classList.remove("punch-button-bounce"),N.offsetWidth,N.classList.add("punch-button-bounce"),setTimeout(()=>{R(r.records,r.filter),ie(r.records).forEach(l=>Re(l))},0)}),s&&t&&s.addEventListener("click",()=>{t.hidden=!0}),t&&t.addEventListener("click",c=>{c.target===t&&(t.hidden=!0)});const a=document.getElementById("achievementBtn"),i=document.getElementById("achievementModal");a&&i&&a.addEventListener("click",()=>{const c=document.getElementById("achievementList");if(c){const d=z();c.innerHTML=le.map(l=>'<div class="achievement-item '+(d.includes(l.id)?"unlocked":"locked")+'"><span class="achievement-icon">'+l.icon+'</span><div class="achievement-info"><span class="achievement-title">'+l.title+'</span><span class="achievement-desc">'+l.desc+"</span></div></div>").join("")}i.hidden=!1});const p=document.getElementById("achievementModalClose");p&&i&&p.addEventListener("click",()=>{i.hidden=!0}),i&&i.addEventListener("click",c=>{c.target===i&&(i.hidden=!0)}),Z.forEach(c=>{c.addEventListener("click",()=>{Z.forEach(d=>d.classList.remove("active")),c.classList.add("active"),r.filter=c.dataset.filter||"all",R(r.records,r.filter)})}),te.forEach(c=>{c.addEventListener("click",()=>{te.forEach(d=>d.classList.remove("active")),c.classList.add("active"),r.historyType=c.dataset.historyType||"all",R(r.records,r.filter)})}),ne&&ne.addEventListener("click",()=>{U()}),oe&&oe.addEventListener("click",()=>{if(O){const c=O;O=null,U(),c()}else U()}),K&&K.addEventListener("click",c=>{c.target===K&&U()}),j.addEventListener("click",c=>{const d=c.target;if(!(d instanceof HTMLElement)||!d.classList.contains("time-delete-btn"))return;const l=d.getAttribute("data-id");if(!l)return;const m=r.records.find(v=>v.id===l);if(!m)return;const D=W(m.type||"other"),E=new Date(m.timestamp);F({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${D}ã€‘åœ¨ã€${C(m.dateKey)} ${q(E)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{r.records=r.records.filter(v=>v.id!==l),_(r.records),R(r.records,r.filter)}})}),Le.addEventListener("click",()=>{const c=document.getElementById("actionsMenu");if(c&&c.classList.contains("open")&&c.classList.remove("open"),!r.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const d=["ç±»å‹","æ—¥æœŸæ—¶é—´"],l=r.records.slice().sort((y,b)=>y.timestamp-b.timestamp).map(y=>{const b=new Date(y.timestamp),A=`${C(y.dateKey)} ${q(b)}`;return[W(y.type||"other"),A]}),m=[d,...l].map(y=>y.map(b=>`"${b}"`).join(",")).join(`
`),D=new Blob([m],{type:"text/csv;charset=utf-8;"}),E=URL.createObjectURL(D),v=document.createElement("a");v.href=E,v.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${T(new Date)}.csv`,v.click(),URL.revokeObjectURL(E)});const f=document.getElementById("importBtn"),u=document.getElementById("punchFileInput");f&&u&&(f.addEventListener("click",()=>{const c=document.getElementById("actionsMenu");c&&c.classList.contains("open")&&c.classList.remove("open"),u.value="",u.click()}),u.addEventListener("change",()=>{const c=u.files&&u.files[0];if(!c)return;const d=new FileReader;d.onload=()=>{try{let l=typeof d.result=="string"?d.result:"";l=l.replace(/^\uFEFF/,"");const m=Ce(l);if(!m.length){alert("æœªè§£æåˆ°æœ‰æ•ˆæ‰“å¡æ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šç±»å‹ã€æ—¥æœŸæ—¶é—´");return}r.records=r.records.concat(m),r.records.sort((D,E)=>D.timestamp-E.timestamp),_(r.records),R(r.records,r.filter),alert("å·²å¯¼å…¥ "+m.length+" æ¡æ‰“å¡è®°å½•")}catch(l){alert("è§£æå¤±è´¥ï¼š"+(l.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ CSV"))}},d.readAsText(c,"UTF-8")})),Be.addEventListener("click",()=>{const c=document.getElementById("actionsMenu");c&&c.classList.contains("open")&&c.classList.remove("open"),r.records.length&&F({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{r.records=[],_(r.records),R(r.records,r.filter)}})});const h=document.getElementById("periodStartBtn");h&&h.addEventListener("click",()=>{const c=Y(r.periodRecords),d=T(new Date);if(c){const l=new Date;l.setDate(l.getDate()-1);const m=T(l);F({title:"å¼€å§‹æ–°å‘¨æœŸ",message:"å½“å‰æœ‰ä¸€å‘¨æœŸæœªç»“æŸï¼Œå°†æŠŠä¸Šä¸€å‘¨æœŸç»“æŸæ—¥è®¾ä¸ºæ˜¨å¤©ï¼Œå†è®°å½•æœ¬æ¬¡å¼€å§‹ã€‚ç¡®å®šï¼Ÿ",onConfirm:()=>{c.endDate=m;const D={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:d,endDate:null};r.periodRecords.push(D),P(r.periodRecords),x()}})}else{const l={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:d,endDate:null};r.periodRecords.push(l),P(r.periodRecords),x()}});const w=document.getElementById("periodEndBtn");w&&w.addEventListener("click",()=>{const c=Y(r.periodRecords);if(!c)return;const d=T(new Date);c.endDate=d,P(r.periodRecords),x()});const B=document.getElementById("periodHistoryList");B&&B.addEventListener("click",c=>{const d=c.target;if(!d.classList.contains("period-history-delete"))return;const l=d.getAttribute("data-period-id");if(!l)return;const m=r.periodRecords.find(E=>E.id===l);if(!m)return;const D=m.endDate?`${C(m.startDate)} ï½ ${C(m.endDate)}`:C(m.startDate)+" ï½ è¿›è¡Œä¸­";F({title:"åˆ é™¤ç»æœŸè®°å½•",message:`ç¡®å®šåˆ é™¤ã€Œ${D}ã€è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{r.periodRecords=r.periodRecords.filter(E=>E.id!==l),P(r.periodRecords),x()}})});const L=document.getElementById("periodActionsMenu"),M=document.getElementById("periodExportBtn");M&&M.addEventListener("click",()=>{if(!r.periodRecords.length){alert("æš‚æ— ç»æœŸæ•°æ®å¯å¯¼å‡º");return}const c=["å¼€å§‹æ—¥æœŸ","ç»“æŸæ—¥æœŸ","å¤©æ•°"],d=[...r.periodRecords].sort((v,y)=>y.startDate>v.startDate?1:-1).map(v=>{const y=v.endDate?C(v.endDate):"è¿›è¡Œä¸­",b=v.endDate?String(Math.round((new Date(v.endDate)-new Date(v.startDate))/(24*60*60*1e3))+1):"-";return[C(v.startDate),y,b]}),l=[c,...d].map(v=>v.map(y=>`"${y}"`).join(",")).join(`
`),m=new Blob([l],{type:"text/csv;charset=utf-8;"}),D=URL.createObjectURL(m),E=document.createElement("a");E.href=D,E.download=`ç»æœŸè®°å½•-${T(new Date)}.csv`,E.click(),URL.revokeObjectURL(D),L&&L.classList.remove("open")});const I=document.getElementById("periodClearBtn");I&&I.addEventListener("click",()=>{r.periodRecords.length&&(L&&L.classList.remove("open"),F({title:"æ¸…ç©ºç»æœŸè®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»æœŸè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{r.periodRecords=[],P(r.periodRecords),x()}}))});const S=document.getElementById("periodImportBtn"),k=document.getElementById("periodFileInput");S&&k&&(S.addEventListener("click",()=>{L&&L.classList.remove("open"),k.value="",k.click()}),k.addEventListener("change",()=>{const c=k.files&&k.files[0];if(!c)return;const d=new FileReader;d.onload=()=>{try{let l=typeof d.result=="string"?d.result:"";l=l.replace(/^\uFEFF/,"");const m=ke(l);if(!m.length){alert("æœªè§£æåˆ°æœ‰æ•ˆç»æœŸæ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸã€å¤©æ•°");return}r.periodRecords=r.periodRecords.concat(m),r.periodRecords.sort((D,E)=>E.startDate>D.startDate?1:-1),P(r.periodRecords),x(),alert("å·²å¯¼å…¥ "+m.length+" æ¡ç»æœŸè®°å½•")}catch(l){alert("è§£æå¤±è´¥ï¼š"+(l.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ç»æœŸ CSV"))}},d.readAsText(c,"UTF-8")}))}document.addEventListener("DOMContentLoaded",function(){$e(),_e(),x();var e=document.getElementById("themeBtn"),t=document.getElementById("themeModal"),n=document.getElementById("themeModalClose"),o=document.getElementById("themeColorInput"),s=document.getElementById("themeResetBtn"),a=document.getElementById("themeHelpBtn"),i=document.getElementById("themeHelpBlock");function p(){var g=pe();g?o.value=g:o.value=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim()||"#6B7FD7",i.hidden=!0,t.hidden=!1}function f(){t.hidden=!0}e&&e.addEventListener("click",p),n&&n.addEventListener("click",f),t&&t.addEventListener("click",function(g){g.target===t&&f()}),o&&o.addEventListener("input",function(){var g=o.value;re(g),he(g)}),s&&s.addEventListener("click",function(){re(null),ye(),f()}),a&&i&&a.addEventListener("click",function(){i.hidden=!i.hidden});var u=document.getElementById("settingsBtn"),h=document.getElementById("settingsModal"),w=document.getElementById("settingsModalClose"),B=document.getElementById("aboutBtn"),L=document.getElementById("aboutModal"),M=document.getElementById("aboutModalClose"),I=document.getElementById("helpBtn"),S=document.getElementById("helpModal"),k=document.getElementById("helpModalClose");function c(){h&&(h.hidden=!1)}function d(){h&&(h.hidden=!0)}function l(){d(),L&&(L.hidden=!1)}function m(){L&&(L.hidden=!0)}function D(){d(),S&&(S.hidden=!1)}function E(){S&&(S.hidden=!0)}u&&u.addEventListener("click",c),w&&w.addEventListener("click",d),h&&h.addEventListener("click",function(g){g.target===h&&d()}),B&&B.addEventListener("click",l),M&&M.addEventListener("click",m),L&&L.addEventListener("click",function(g){g.target===L&&m()}),I&&I.addEventListener("click",D),k&&k.addEventListener("click",E),S&&S.addEventListener("click",function(g){g.target===S&&E()});var v=document.getElementById("actionsFabToggle"),y=document.getElementById("actionsMenu"),b=document.getElementById("periodActionsMenu");v&&y&&b&&(v.addEventListener("click",function(){var g=r.activeTab==="punch"?y:b,$=r.activeTab==="punch"?b:y;$.classList.remove("open"),g.classList.toggle("open")}),document.addEventListener("click",function(g){v.contains(g.target)||y.contains(g.target)||b.contains(g.target)||(y.classList.contains("open")||b.classList.contains("open"))&&(y.classList.remove("open"),b.classList.remove("open"))}));var A=document.getElementById("panelPunch"),H=document.getElementById("panelPeriod"),Q=document.querySelectorAll(".tab-bar-item");document.getElementById("actionsFab");function ge(g){r.activeTab=g,y&&y.classList.contains("open")&&y.classList.remove("open"),b&&b.classList.contains("open")&&b.classList.remove("open"),g==="punch"?(A&&(A.classList.add("active"),A.removeAttribute("hidden")),H&&(H.classList.remove("active"),H.hidden=!0)):(A&&(A.classList.remove("active"),A.hidden=!0),H&&(H.classList.add("active"),H.removeAttribute("hidden")),x()),Q.forEach(function($){$.getAttribute("data-tab")===g?($.classList.add("active"),$.setAttribute("aria-selected","true")):($.classList.remove("active"),$.setAttribute("aria-selected","false"))})}Q.forEach(function(g){g.addEventListener("click",function(){var $=g.getAttribute("data-tab");$&&ge($)})})});
