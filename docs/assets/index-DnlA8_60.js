(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(r){if(r.ep)return;r.ep=!0;const c=t(r);fetch(r.href,c)}})();const _=document.getElementById("punchBtn"),J=document.getElementById("todayCount"),G=document.getElementById("streakCount"),N=document.getElementById("lastPunchTime"),E=document.getElementById("historyList"),O=document.querySelectorAll(".filter-tab"),W=document.getElementById("exportBtn"),Y=document.getElementById("clearBtn"),M=document.querySelectorAll(".type-tab"),A=document.querySelectorAll(".history-type-tab"),m=document.getElementById("confirmModal"),z=document.getElementById("modalTitle"),Q=document.getElementById("modalMessage"),P=document.getElementById("modalCancel"),q=document.getElementById("modalConfirm"),H="punch_records_v1";function V(){try{const n=localStorage.getItem(H);if(!n)return[];const e=JSON.parse(n);return Array.isArray(e)?e:[]}catch(n){return console.error("Failed to load records",n),[]}}function $(n){localStorage.setItem(H,JSON.stringify(n))}function u(n){return n.toISOString().slice(0,10)}function j(n){const e=new Map;return n.forEach(t=>{e.has(t.dateKey)||e.set(t.dateKey,[]),e.get(t.dateKey).push(t)}),Array.from(e.entries()).sort((t,o)=>t[0]<o[0]?1:-1).map(([t,o])=>({dateKey:t,recs:o}))}function v(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),o=String(n.getSeconds()).padStart(2,"0");return`${e}:${t}:${o}`}function k(n){const[e,t,o]=n.split("-");return`${e}å¹´${Number(t)}æœˆ${Number(o)}æ—¥`}function X(n){const e=u(new Date);return n.filter(t=>t.dateKey===e).length}function Z(n){if(!n.length)return 0;const e=j(n);let t=0,o=new Date,r=u(o);for(let c=0;c<e.length;c++){const{dateKey:i}=e[c];if(i===r)t++,o.setDate(o.getDate()-1),r=u(o);else break}return t}function U(n){switch(n){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function ee(n,e){const t=new Date,o=u(t);if(e==="today")return n.filter(r=>r.dateKey===o);if(e==="week"){const r=new Date;r.setDate(t.getDate()-6);const c=u(r);return n.filter(i=>i.dateKey>=c)}if(e==="month"){const[r,c]=o.split("-"),i=`${r}-${c}`;return n.filter(a=>a.dateKey.startsWith(i))}return n}function l(n,e="all"){if(J.textContent=String(X(n)),G.textContent=String(Z(n)),!n.length)N.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const i=n[n.length-1],a=new Date(i.timestamp);N.textContent=`æœ€åä¸€æ¬¡ï¼š${k(i.dateKey)} ${v(a)}`}const t=ee(n,e);if(E.innerHTML="",!t.length){E.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const o=document.createDocumentFragment(),r=s.historyType||"all";["toilet","meal","fitness","other"].forEach(i=>{if(r!=="all"&&r!==i)return;const a=t.filter(f=>(f.type||"other")===i);if(!a.length)return;const d=document.createElement("div");d.className=`history-type-block history-type-block-${i}`;const C=document.createElement("div");C.className="history-item";const L=document.createElement("div"),T=document.createElement("div");T.className="history-date",T.textContent=U(i);const B=document.createElement("div");B.className="history-time",B.textContent=`å…± ${a.length} æ¬¡`,L.appendChild(T),L.appendChild(B),C.appendChild(L),d.appendChild(C),j(a.slice().sort((f,w)=>f.timestamp-w.timestamp)).forEach(({dateKey:f,recs:w})=>{const D=document.createElement("div");D.className="history-item";const S=document.createElement("div"),b=document.createElement("div");b.className="history-date",b.textContent=k(f);const K=document.createElement("div");K.className="history-time-list",w.forEach(x=>{const R=new Date(x.timestamp),y=document.createElement("div");y.className="time-chip";const I=document.createElement("span");I.textContent=v(R);const h=document.createElement("button");h.className="time-delete-btn",h.textContent="åˆ ",h.setAttribute("data-id",x.id),y.appendChild(I),y.appendChild(h),K.appendChild(y)}),S.appendChild(b),S.appendChild(K),D.appendChild(S),d.appendChild(D)}),o.appendChild(d)}),E.appendChild(o)}let s={records:[],filter:"all",currentType:"fitness",historyType:"all"},p=null;function F(n){const{title:e,message:t,onConfirm:o}=n;if(!m){window.confirm(t)&&typeof o=="function"&&o();return}z.textContent=e||"ç¡®è®¤æ“ä½œ",Q.textContent=t||"",p=typeof o=="function"?o:null,m.hidden=!1}function g(){m&&(m.hidden=!0),p=null}function te(){s.records=V(),M.forEach(e=>{e.addEventListener("click",()=>{M.forEach(t=>t.classList.remove("active")),e.classList.add("active"),s.currentType=e.dataset.type||"fitness",l(s.records,s.filter)})});const n=document.querySelector(".type-tab.active");n&&(s.currentType=n.dataset.type||"fitness"),l(s.records,s.filter),_.addEventListener("click",()=>{const e=new Date,t={id:`${e.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:e.getTime(),dateKey:u(e),type:s.currentType};s.records.push(t),$(s.records),l(s.records,s.filter)}),O.forEach(e=>{e.addEventListener("click",()=>{O.forEach(t=>t.classList.remove("active")),e.classList.add("active"),s.filter=e.dataset.filter||"all",l(s.records,s.filter)})}),A.forEach(e=>{e.addEventListener("click",()=>{A.forEach(t=>t.classList.remove("active")),e.classList.add("active"),s.historyType=e.dataset.historyType||"all",l(s.records,s.filter)})}),P&&P.addEventListener("click",()=>{g()}),q&&q.addEventListener("click",()=>{if(p){const e=p;p=null,g(),e()}else g()}),m&&m.addEventListener("click",e=>{e.target===m&&g()}),E.addEventListener("click",e=>{const t=e.target;if(!(t instanceof HTMLElement)||!t.classList.contains("time-delete-btn"))return;const o=t.getAttribute("data-id");if(!o)return;const r=s.records.find(a=>a.id===o);if(!r)return;const c=U(r.type||"other"),i=new Date(r.timestamp);F({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${c}ã€‘åœ¨ã€${k(r.dateKey)} ${v(i)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{s.records=s.records.filter(a=>a.id!==o),$(s.records),l(s.records,s.filter)}})}),W.addEventListener("click",()=>{if(!s.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const e=["ç±»å‹","æ—¥æœŸ","æ—¶é—´","æ—¶é—´æˆ³"],t=s.records.slice().sort((a,d)=>a.timestamp-d.timestamp).map(a=>{const d=new Date(a.timestamp);return[a.type||"other",a.dateKey,v(d),String(a.timestamp)]}),o=[e,...t].map(a=>a.map(d=>`"${d}"`).join(",")).join(`
`),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(r),i=document.createElement("a");i.href=c,i.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${u(new Date)}.csv`,i.click(),URL.revokeObjectURL(c)}),Y.addEventListener("click",()=>{s.records.length&&F({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{s.records=[],$(s.records),l(s.records,s.filter)}})})}document.addEventListener("DOMContentLoaded",te);
