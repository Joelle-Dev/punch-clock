(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const x=document.getElementById("punchBtn"),he=document.getElementById("todayCount"),ye=document.getElementById("streakCount"),Y=document.getElementById("lastPunchTime"),H=document.getElementById("historyList"),G=document.querySelectorAll(".filter-tab"),ge=document.getElementById("exportBtn"),ve=document.getElementById("clearBtn"),z=document.querySelectorAll(".type-tab"),Q=document.querySelectorAll(".history-type-tab"),b=document.getElementById("confirmModal"),Ee=document.getElementById("modalTitle"),Le=document.getElementById("modalMessage"),X=document.getElementById("modalCancel"),Z=document.getElementById("modalConfirm"),R=document.getElementById("praiseWrap"),ee=document.getElementById("praiseText"),O=document.getElementById("praiseHearts"),se="punch_records_v1",oe="punch_period_records_v1",U="punch_theme_v1",ie="punch_achievements_v1",ae=[{id:"streak7",title:"è¿ç»­ 7 å¤©",desc:"è¿ç»­æ‰“å¡æ»¡ 7 å¤©",icon:"ğŸ”¥",check:e=>de(e)>=7},{id:"toilet30",title:"å¦‚å•è¾¾äºº",desc:"å¦‚å•æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš½",check:e=>_(e,"toilet").length>=30},{id:"meal30",title:"é¥­å¦è¾¾äºº",desc:"é¥­å¦æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš",check:e=>_(e,"meal").length>=30},{id:"fitness30",title:"å¥èº«è¾¾äºº",desc:"å¥èº«æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸ’ª",check:e=>_(e,"fitness").length>=30},{id:"days100",title:"åšæŒ 100 å¤©",desc:"ä½¿ç”¨æ‰“å¡æ»¡ 100 å¤©",icon:"ğŸ“…",check:e=>{if(!e.length)return!1;const t=e.slice().sort((r,o)=>r.timestamp-o.timestamp)[0];return Math.floor((Date.now()-t.timestamp)/(24*60*60*1e3))>=100}},{id:"all4",title:"å…¨èƒ½æ—¥",desc:"åŒä¸€å¤©æ‰“è¿‡å…¨éƒ¨ 4 ç§ç±»å‹",icon:"ğŸŒŸ",check:e=>W(e).some(({recs:n})=>new Set(n.map(o=>o.type||"other")).size>=4)}];function De(){try{const e=localStorage.getItem(se);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load records",e),[]}}function A(e){localStorage.setItem(se,JSON.stringify(e))}function I(e){return e.toISOString().slice(0,10)}function W(e){const t=new Map;return e.forEach(n=>{t.has(n.dateKey)||t.set(n.dateKey,[]),t.get(n.dateKey).push(n)}),Array.from(t.entries()).sort((n,r)=>n[0]<r[0]?1:-1).map(([n,r])=>({dateKey:n,recs:r}))}function F(e){const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),r=String(e.getSeconds()).padStart(2,"0");return`${t}:${n}:${r}`}function D(e){const[t,n,r]=e.split("-");return`${t}å¹´${Number(n)}æœˆ${Number(r)}æ—¥`}function ce(e){const t=[];let n=0;for(;n<e.length;)if(e[n]==='"'){let r="";for(n++;n<e.length&&(e[n]!=='"'||e[n+1]==='"');)r+=e[n]==='"'&&e[n+1]==='"'?'"':e[n],n++;e[n]==='"'&&n++,t.push(r),e[n]===","&&n++}else{const r=e.indexOf(",",n),o=r===-1?e.slice(n):e.slice(n,r);t.push(o.trim()),n=r===-1?e.length:r+1}return t}function Be(e){return{å¦‚å•:"toilet",é¥­å¦:"meal",å¥èº«:"fitness",å…¶ä»–:"other"}[e]||"other"}function Ie(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);if(!t)return null;const[,n,r,o]=t,a=`${n}-${String(r).padStart(2,"0")}-${String(o).padStart(2,"0")}`,c=/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/.exec(e),f=c?parseInt(c[1],10):12,y=c?parseInt(c[2],10):0,h=c&&c[3]?parseInt(c[3],10):0,g=new Date(parseInt(n,10),parseInt(r,10)-1,parseInt(o,10),f,y,h);return{dateKey:a,timestamp:g.getTime()}}function te(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);return t?`${t[1]}-${String(t[2]).padStart(2,"0")}-${String(t[3]).padStart(2,"0")}`:null}function Se(e){const t=e.split(/\r?\n/).filter(r=>r.trim()),n=[];for(let r=0;r<t.length;r++){const o=ce(t[r]);if(o.length<2)continue;const a=o[0].trim(),c=o[1].trim();if(r===0&&(a==="ç±»å‹"||a==="æ—¥æœŸæ—¶é—´"))continue;const f=Be(a),y=Ie(c);y&&n.push({id:`import-${y.timestamp}-${Math.random().toString(36).slice(2,6)}`,timestamp:y.timestamp,dateKey:y.dateKey,type:f})}return n}function Te(e){const t=e.split(/\r?\n/).filter(r=>r.trim()),n=[];for(let r=0;r<t.length;r++){const o=ce(t[r]);if(o.length<2)continue;const a=o[0].trim(),c=o[1].trim();if(r===0&&(a==="å¼€å§‹æ—¥æœŸ"||c==="ç»“æŸæ—¥æœŸ"))continue;const f=te(a);if(!f)continue;const y=c==="è¿›è¡Œä¸­"||!c?null:te(c);n.push({id:`p-import-${Date.now()}-${r}-${Math.random().toString(36).slice(2,6)}`,startDate:f,endDate:y||null})}return n}function we(e){const t=I(new Date);return e.filter(n=>n.dateKey===t).length}function de(e){if(!e.length)return 0;const t=W(e);let n=0,r=new Date,o=I(r);for(let a=0;a<t.length;a++){const{dateKey:c}=t[a];if(c===o)n++,r.setDate(r.getDate()-1),o=I(r);else break}return n}function j(e){switch(e){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function le(){try{const e=localStorage.getItem(U);if(e&&/^#[0-9A-Fa-f]{6}$/.test(e))return e}catch(e){console.error("Failed to load theme",e)}return null}function ne(e){e?localStorage.setItem(U,e):localStorage.removeItem(U)}function me(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function be(e,t){const{r:n,g:r,b:o}=me(e);return"#"+[n,r,o].map(a=>Math.round(Math.max(0,a*(1-t))).toString(16).padStart(2,"0")).join("")}function ue(e){const t=document.documentElement;t.classList.forEach(a=>{a.startsWith("theme-day-")&&t.classList.remove(a)}),t.style.setProperty("--primary",e),t.style.setProperty("--primary-dark",be(e,.15));const{r:n,g:r,b:o}=me(e);t.style.setProperty("--primary-soft",`rgba(${n}, ${r}, ${o}, 0.15)`)}function pe(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-dark"),e.style.removeProperty("--primary-soft"),e.classList.forEach(n=>{n.startsWith("theme-day-")&&e.classList.remove(n)});const t=new Date().getDay();e.classList.add("theme-day-"+t)}function Ce(){const e=le();e?ue(e):pe()}function V(){try{const e=localStorage.getItem(ie);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function ke(e){localStorage.setItem(ie,JSON.stringify(e))}function re(e){const t=V(),n=[];return ae.forEach(r=>{t.includes(r.id)||r.check(e)&&(n.push(r),t.push(r.id))}),n.length&&ke(t),n}function Me(e){const t=document.getElementById("achievementToast");if(!t)return;const n=t.querySelector(".achievement-toast-title"),r=t.querySelector(".achievement-toast-icon");n&&(n.textContent="æ­å–œï¼"+e.title),r&&(r.textContent=e.icon),t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),2500)}function $e(e,t,n){const r=`${t}-${String(n).padStart(2,"0")}`,o={};return e.forEach(a=>{a.dateKey.startsWith(r)&&(o[a.dateKey]=(o[a.dateKey]||0)+1)}),o}function xe(e,t){if(!e)return;const n=new Date,r=n.getFullYear(),o=n.getMonth()+1,a=$e(t,r,o),c=new Date(r,o-1,1),y=new Date(r,o-1+1,0).getDate(),h=c.getDay();let g='<div class="heatmap-grid">';["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(s=>{g+='<span class="heatmap-week-label">'+s+"</span>"});for(let s=0;s<h;s++)g+='<span class="heatmap-cell heatmap-cell-empty"></span>';for(let s=1;s<=y;s++){const l=`${r}-${String(o).padStart(2,"0")}-${String(s).padStart(2,"0")}`,d=a[l]||0;let m="heatmap-cell-0";d>=6?m="heatmap-cell-4":d>=4?m="heatmap-cell-3":d>=2?m="heatmap-cell-2":d>=1&&(m="heatmap-cell-1");const u=d?`${l} æ‰“å¡ ${d} æ¬¡`:l;g+='<span class="heatmap-cell '+m+'" title="'+u+'">'+(d||"")+"</span>"}g+="</div>",e.innerHTML=g}function Re(e){switch(e){case"toilet":return"ç§‹ç‘¾åˆæ‹‰ç²‘ç²‘å•¦ï½";case"meal":return"ç§‹ç‘¾çœŸä¹–ï¼Œåƒé¥­é¦™é¦™ï½";case"fitness":return"ç§‹ç‘¾å¨æ­¦ï¼ŒèŒå£®æˆé•¿ï½";default:return"ç§‹ç‘¾çœŸæ£’ï½"}}function Ae(e,t){const n=new Date,r=I(n);if(t==="today")return e.filter(o=>o.dateKey===r);if(t==="week"){const o=new Date;o.setDate(n.getDate()-6);const a=I(o);return e.filter(c=>c.dateKey>=a)}if(t==="month"){const[o,a]=r.split("-"),c=`${o}-${a}`;return e.filter(f=>f.dateKey.startsWith(c))}return e}function T(e,t="all"){if(he.textContent=String(we(e)),ye.textContent=String(de(e)),!e.length)Y.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const f=e[e.length-1],y=new Date(f.timestamp);Y.textContent=`æœ€åä¸€æ¬¡ï¼š${D(f.dateKey)} ${F(y)}`}const n=Ae(e,t);if(H.innerHTML="",!n.length){H.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const r=document.createDocumentFragment(),o=i.historyType||"all";["toilet","meal","fitness","other"].forEach(f=>{if(o!=="all"&&o!==f)return;const y=n.filter(m=>(m.type||"other")===f);if(!y.length)return;const h=document.createElement("div");h.className=`history-type-block history-type-block-${f}`;const g=document.createElement("div");g.className="history-item";const E=document.createElement("div"),s=document.createElement("div");s.className="history-date",s.textContent=j(f);const l=document.createElement("div");l.className="history-time",l.textContent=`å…± ${y.length} æ¬¡`,E.appendChild(s),E.appendChild(l),g.appendChild(E),h.appendChild(g),W(y.slice().sort((m,u)=>m.timestamp-u.timestamp)).forEach(({dateKey:m,recs:u})=>{const p=document.createElement("div");p.className="history-item";const v=document.createElement("div"),L=document.createElement("div");L.className="history-date",L.textContent=D(m);const B=document.createElement("div");B.className="history-time-list",u.forEach(S=>{const fe=new Date(S.timestamp),M=document.createElement("div");M.className="time-chip";const J=document.createElement("span");J.textContent=F(fe);const $=document.createElement("button");$.className="time-delete-btn",$.textContent="åˆ ",$.setAttribute("data-id",S.id),M.appendChild(J),M.appendChild($),B.appendChild(M)}),v.appendChild(L),v.appendChild(B),p.appendChild(v),h.appendChild(p)}),r.appendChild(h)}),H.appendChild(r),xe(document.getElementById("heatmapContainer"),i.records);const c=document.getElementById("achievementCount");c&&(c.textContent=String(V().length))}let i={records:[],filter:"all",currentType:"fitness",historyType:"all",periodRecords:[],activeTab:"punch"},k=null,N=null;function P(e){const{title:t,message:n,onConfirm:r}=e;if(!b){window.confirm(n)&&typeof r=="function"&&r();return}Ee.textContent=t||"ç¡®è®¤æ“ä½œ",Le.textContent=n||"",k=typeof r=="function"?r:null,b.hidden=!1}function K(){b&&(b.hidden=!0),k=null}function _(e,t){return t?e.filter(n=>(n.type||"other")===t):e}function Pe(){try{const e=localStorage.getItem(oe);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load period records",e),[]}}function C(e){localStorage.setItem(oe,JSON.stringify(e))}function q(e){return e.filter(t=>!t.endDate).sort((t,n)=>n.startDate>t.startDate?1:-1)[0]||null}function Ke(e){const t=e.map(c=>c.startDate).filter(Boolean).sort();if(t.length<2)return null;const n=[];for(let c=1;c<t.length;c++){const f=new Date(t[c-1]),y=new Date(t[c]),h=Math.round((y-f)/(24*60*60*1e3));h>0&&h<90&&n.push(h)}if(!n.length)return null;const r=Math.round(n.reduce((c,f)=>c+f,0)/n.length),o=t[t.length-1],a=new Date(o);return a.setDate(a.getDate()+r),{dateKey:I(a),avgCycle:r}}function w(){const e=document.getElementById("periodStatus"),t=document.getElementById("periodPrediction"),n=document.getElementById("periodHistoryList"),r=document.getElementById("periodStartBtn"),o=document.getElementById("periodEndBtn");if(!e||!t||!n)return;const a=i.periodRecords,c=q(a);I(new Date),c?(e.innerHTML=`
      <div class="period-status-title">è¿›è¡Œä¸­</div>
      <div>å¼€å§‹ï¼š${D(c.startDate)}</div>
      <div>ç»“æŸï¼šå°šæœªè®°å½•</div>
    `,o&&(o.disabled=!1),r&&(r.disabled=!0)):(e.innerHTML=`
      <div class="period-status-title">æœªåœ¨ç»æœŸ</div>
      <div>è®°å½•ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€å¼€å§‹æ–°å‘¨æœŸ</div>
    `,o&&(o.disabled=!0),r&&(r.disabled=!1));const f=Ke(a);f?(t.innerHTML=`
      <div class="period-prediction-title">é¢„è®¡ä¸‹æ¬¡å¼€å§‹</div>
      <div class="period-prediction-value">${D(f.dateKey)}</div>
      <div class="period-prediction-hint">åŸºäºå¹³å‡å‘¨æœŸ ${f.avgCycle} å¤©ï¼Œä»…ä¾›å‚è€ƒ</div>
    `,t.hidden=!1):(t.innerHTML=`
      <div class="period-prediction-title">é¢„æµ‹</div>
      <div class="period-prediction-hint">å†è®°å½•è‡³å°‘ 2 æ¬¡ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€åä¼šæ˜¾ç¤ºé¢„æµ‹</div>
    `,t.hidden=!1);const y=[...a].sort((h,g)=>g.startDate>h.startDate?1:-1);if(!y.length){n.innerHTML='<div class="period-empty">æš‚æ— ç»æœŸè®°å½•</div>';return}n.innerHTML="",y.forEach(h=>{const g=document.createElement("div");g.className="period-history-item";const E=h.endDate?`${D(h.startDate)} ï½ ${D(h.endDate)}`:`${D(h.startDate)} ï½ è¿›è¡Œä¸­`,s=h.endDate?Math.round((new Date(h.endDate)-new Date(h.startDate))/(24*60*60*1e3))+1:"";g.innerHTML=`
      <span class="period-range">${E}</span>
      <span class="period-days">${s?s+" å¤©":""}</span>
      <button type="button" class="period-history-delete" data-period-id="${h.id}">åˆ </button>
    `,n.appendChild(g)})}function He(){i.records=De(),i.periodRecords=Pe(),z.forEach(s=>{s.addEventListener("click",()=>{z.forEach(l=>l.classList.remove("active")),s.classList.add("active"),i.currentType=s.dataset.type||"fitness",T(i.records,i.filter)})});const e=document.querySelector(".type-tab.active");e&&(i.currentType=e.dataset.type||"fitness"),T(i.records,i.filter),re(i.records),x.addEventListener("click",()=>{const s=new Date,l={id:`${s.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:s.getTime(),dateKey:I(s),type:i.currentType};if(i.records.push(l),A(i.records),T(i.records,i.filter),x.classList.remove("punch-button-bounce"),x.offsetWidth,x.classList.add("punch-button-bounce"),ee&&(ee.textContent=Re(i.currentType)),R&&R.classList.add("show"),O){O.innerHTML="";const m=["â¤","ğŸ’œ","ğŸ’—"],u=32;for(let p=0;p<8;p++){const v=p/8*2*Math.PI-Math.PI/2,L=Math.cos(v)*u,B=Math.sin(v)*u,S=document.createElement("span");S.className="heart-burst",S.textContent=m[p%m.length],S.style.setProperty("--tx",L+"px"),S.style.setProperty("--ty",B+"px"),S.style.setProperty("--delay",p*40+"ms"),O.appendChild(S)}}N&&clearTimeout(N),N=setTimeout(()=>{R&&R.classList.remove("show")},1800),re(i.records).forEach(m=>Me(m))});const t=document.getElementById("achievementBtn"),n=document.getElementById("achievementModal");t&&n&&t.addEventListener("click",()=>{const s=document.getElementById("achievementList");if(s){const l=V();s.innerHTML=ae.map(d=>'<div class="achievement-item '+(l.includes(d.id)?"unlocked":"locked")+'"><span class="achievement-icon">'+d.icon+'</span><div class="achievement-info"><span class="achievement-title">'+d.title+'</span><span class="achievement-desc">'+d.desc+"</span></div></div>").join("")}n.hidden=!1});const r=document.getElementById("achievementModalClose");r&&n&&r.addEventListener("click",()=>{n.hidden=!0}),n&&n.addEventListener("click",s=>{s.target===n&&(n.hidden=!0)}),G.forEach(s=>{s.addEventListener("click",()=>{G.forEach(l=>l.classList.remove("active")),s.classList.add("active"),i.filter=s.dataset.filter||"all",T(i.records,i.filter)})}),Q.forEach(s=>{s.addEventListener("click",()=>{Q.forEach(l=>l.classList.remove("active")),s.classList.add("active"),i.historyType=s.dataset.historyType||"all",T(i.records,i.filter)})}),X&&X.addEventListener("click",()=>{K()}),Z&&Z.addEventListener("click",()=>{if(k){const s=k;k=null,K(),s()}else K()}),b&&b.addEventListener("click",s=>{s.target===b&&K()}),H.addEventListener("click",s=>{const l=s.target;if(!(l instanceof HTMLElement)||!l.classList.contains("time-delete-btn"))return;const d=l.getAttribute("data-id");if(!d)return;const m=i.records.find(v=>v.id===d);if(!m)return;const u=j(m.type||"other"),p=new Date(m.timestamp);P({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${u}ã€‘åœ¨ã€${D(m.dateKey)} ${F(p)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{i.records=i.records.filter(v=>v.id!==d),A(i.records),T(i.records,i.filter)}})}),ge.addEventListener("click",()=>{const s=document.getElementById("actionsMenu");if(s&&s.classList.contains("open")&&s.classList.remove("open"),!i.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const l=["ç±»å‹","æ—¥æœŸæ—¶é—´"],d=i.records.slice().sort((L,B)=>L.timestamp-B.timestamp).map(L=>{const B=new Date(L.timestamp),S=`${D(L.dateKey)} ${F(B)}`;return[j(L.type||"other"),S]}),m=[l,...d].map(L=>L.map(B=>`"${B}"`).join(",")).join(`
`),u=new Blob([m],{type:"text/csv;charset=utf-8;"}),p=URL.createObjectURL(u),v=document.createElement("a");v.href=p,v.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${I(new Date)}.csv`,v.click(),URL.revokeObjectURL(p)});const o=document.getElementById("importBtn"),a=document.getElementById("punchFileInput");o&&a&&(o.addEventListener("click",()=>{const s=document.getElementById("actionsMenu");s&&s.classList.contains("open")&&s.classList.remove("open"),a.value="",a.click()}),a.addEventListener("change",()=>{const s=a.files&&a.files[0];if(!s)return;const l=new FileReader;l.onload=()=>{try{let d=typeof l.result=="string"?l.result:"";d=d.replace(/^\uFEFF/,"");const m=Se(d);if(!m.length){alert("æœªè§£æåˆ°æœ‰æ•ˆæ‰“å¡æ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šç±»å‹ã€æ—¥æœŸæ—¶é—´");return}i.records=i.records.concat(m),i.records.sort((u,p)=>u.timestamp-p.timestamp),A(i.records),T(i.records,i.filter),alert("å·²å¯¼å…¥ "+m.length+" æ¡æ‰“å¡è®°å½•")}catch(d){alert("è§£æå¤±è´¥ï¼š"+(d.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ CSV"))}},l.readAsText(s,"UTF-8")})),ve.addEventListener("click",()=>{const s=document.getElementById("actionsMenu");s&&s.classList.contains("open")&&s.classList.remove("open"),i.records.length&&P({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{i.records=[],A(i.records),T(i.records,i.filter)}})});const c=document.getElementById("periodStartBtn");c&&c.addEventListener("click",()=>{const s=q(i.periodRecords),l=I(new Date);if(s){const d=new Date;d.setDate(d.getDate()-1);const m=I(d);P({title:"å¼€å§‹æ–°å‘¨æœŸ",message:"å½“å‰æœ‰ä¸€å‘¨æœŸæœªç»“æŸï¼Œå°†æŠŠä¸Šä¸€å‘¨æœŸç»“æŸæ—¥è®¾ä¸ºæ˜¨å¤©ï¼Œå†è®°å½•æœ¬æ¬¡å¼€å§‹ã€‚ç¡®å®šï¼Ÿ",onConfirm:()=>{s.endDate=m;const u={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:l,endDate:null};i.periodRecords.push(u),C(i.periodRecords),w()}})}else{const d={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:l,endDate:null};i.periodRecords.push(d),C(i.periodRecords),w()}});const f=document.getElementById("periodEndBtn");f&&f.addEventListener("click",()=>{const s=q(i.periodRecords);if(!s)return;const l=I(new Date);s.endDate=l,C(i.periodRecords),w()});const y=document.getElementById("periodHistoryList");y&&y.addEventListener("click",s=>{const l=s.target;if(!l.classList.contains("period-history-delete"))return;const d=l.getAttribute("data-period-id");if(!d)return;const m=i.periodRecords.find(p=>p.id===d);if(!m)return;const u=m.endDate?`${D(m.startDate)} ï½ ${D(m.endDate)}`:D(m.startDate)+" ï½ è¿›è¡Œä¸­";P({title:"åˆ é™¤ç»æœŸè®°å½•",message:`ç¡®å®šåˆ é™¤ã€Œ${u}ã€è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{i.periodRecords=i.periodRecords.filter(p=>p.id!==d),C(i.periodRecords),w()}})});const h=document.getElementById("periodExportBtn");h&&h.addEventListener("click",()=>{if(!i.periodRecords.length){alert("æš‚æ— ç»æœŸæ•°æ®å¯å¯¼å‡º");return}const s=["å¼€å§‹æ—¥æœŸ","ç»“æŸæ—¥æœŸ","å¤©æ•°"],l=[...i.periodRecords].sort((v,L)=>L.startDate>v.startDate?1:-1).map(v=>{const L=v.endDate?D(v.endDate):"è¿›è¡Œä¸­",B=v.endDate?String(Math.round((new Date(v.endDate)-new Date(v.startDate))/(24*60*60*1e3))+1):"-";return[D(v.startDate),L,B]}),d=[s,...l].map(v=>v.map(L=>`"${L}"`).join(",")).join(`
`),m=new Blob([d],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(m),p=document.createElement("a");p.href=u,p.download=`ç»æœŸè®°å½•-${I(new Date)}.csv`,p.click(),URL.revokeObjectURL(u)});const g=document.getElementById("periodImportBtn"),E=document.getElementById("periodFileInput");g&&E&&(g.addEventListener("click",()=>{E.value="",E.click()}),E.addEventListener("change",()=>{const s=E.files&&E.files[0];if(!s)return;const l=new FileReader;l.onload=()=>{try{let d=typeof l.result=="string"?l.result:"";d=d.replace(/^\uFEFF/,"");const m=Te(d);if(!m.length){alert("æœªè§£æåˆ°æœ‰æ•ˆç»æœŸæ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸã€å¤©æ•°");return}i.periodRecords=i.periodRecords.concat(m),i.periodRecords.sort((u,p)=>p.startDate>u.startDate?1:-1),C(i.periodRecords),w(),alert("å·²å¯¼å…¥ "+m.length+" æ¡ç»æœŸè®°å½•")}catch(d){alert("è§£æå¤±è´¥ï¼š"+(d.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ç»æœŸ CSV"))}},l.readAsText(s,"UTF-8")}))}document.addEventListener("DOMContentLoaded",function(){Ce(),He(),w();var e=document.getElementById("themeBtn"),t=document.getElementById("themeModal"),n=document.getElementById("themeModalClose"),r=document.getElementById("themeColorInput"),o=document.getElementById("themeResetBtn"),a=document.getElementById("themeHelpBtn"),c=document.getElementById("themeHelpBlock");function f(){var u=le();u?r.value=u:r.value=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim()||"#6B7FD7",c.hidden=!0,t.hidden=!1}function y(){t.hidden=!0}e&&e.addEventListener("click",f),n&&n.addEventListener("click",y),t&&t.addEventListener("click",function(u){u.target===t&&y()}),r&&r.addEventListener("input",function(){var u=r.value;ne(u),ue(u)}),o&&o.addEventListener("click",function(){ne(null),pe(),y()}),a&&c&&a.addEventListener("click",function(){c.hidden=!c.hidden});var h=document.getElementById("actionsFabToggle"),g=document.getElementById("actionsMenu");h&&g&&(h.addEventListener("click",function(){g.classList.toggle("open")}),document.addEventListener("click",function(u){g.classList.contains("open")&&!h.contains(u.target)&&!g.contains(u.target)&&g.classList.remove("open")}));var E=document.getElementById("panelPunch"),s=document.getElementById("panelPeriod"),l=document.querySelectorAll(".tab-bar-item"),d=document.getElementById("actionsFab");function m(u){i.activeTab=u,u==="punch"?(E&&(E.classList.add("active"),E.removeAttribute("hidden")),s&&(s.classList.remove("active"),s.hidden=!0),d&&d.classList.remove("tab-period-hidden")):(E&&(E.classList.remove("active"),E.hidden=!0),s&&(s.classList.add("active"),s.removeAttribute("hidden")),d&&d.classList.add("tab-period-hidden"),w()),l.forEach(function(p){p.getAttribute("data-tab")===u?(p.classList.add("active"),p.setAttribute("aria-selected","true")):(p.classList.remove("active"),p.setAttribute("aria-selected","false"))})}l.forEach(function(u){u.addEventListener("click",function(){var p=u.getAttribute("data-tab");p&&m(p)})})});
