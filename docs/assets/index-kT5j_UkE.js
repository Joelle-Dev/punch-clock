(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const N=document.getElementById("punchBtn"),Ee=document.getElementById("todayCount"),Le=document.getElementById("streakCount"),Q=document.getElementById("lastPunchTime"),j=document.getElementById("historyList"),X=document.querySelectorAll(".filter-tab"),Be=document.getElementById("exportBtn"),De=document.getElementById("clearBtn"),Z=document.querySelectorAll(".type-tab"),ee=document.querySelectorAll(".history-type-tab"),K=document.getElementById("confirmModal"),be=document.getElementById("modalTitle"),Se=document.getElementById("modalMessage"),te=document.getElementById("modalCancel"),ne=document.getElementById("modalConfirm"),ce="punch_records_v1",ae="punch_period_records_v1",J="punch_theme_v1",de="punch_achievements_v1",le=[{id:"streak7",title:"è¿ç»­ 7 å¤©",desc:"è¿ç»­æ‰“å¡æ»¡ 7 å¤©",icon:"ğŸ”¥",check:e=>me(e)>=7},{id:"toilet30",title:"å¦‚å•è¾¾äºº",desc:"å¦‚å•æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš½",check:e=>V(e,"toilet").length>=30},{id:"meal30",title:"é¥­å¦è¾¾äºº",desc:"é¥­å¦æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš",check:e=>V(e,"meal").length>=30},{id:"fitness30",title:"å¥èº«è¾¾äºº",desc:"å¥èº«æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸ’ª",check:e=>V(e,"fitness").length>=30},{id:"days100",title:"åšæŒ 100 å¤©",desc:"ä½¿ç”¨æ‰“å¡æ»¡ 100 å¤©",icon:"ğŸ“…",check:e=>{if(!e.length)return!1;const t=e.slice().sort((o,s)=>o.timestamp-s.timestamp)[0];return Math.floor((Date.now()-t.timestamp)/(24*60*60*1e3))>=100}},{id:"all4",title:"å…¨èƒ½æ—¥",desc:"åŒä¸€å¤©æ‰“è¿‡å…¨éƒ¨ 4 ç§ç±»å‹",icon:"ğŸŒŸ",check:e=>G(e).some(({recs:n})=>new Set(n.map(s=>s.type||"other")).size>=4)}];function Ie(){try{const e=localStorage.getItem(ce);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load records",e),[]}}function _(e){localStorage.setItem(ce,JSON.stringify(e))}function w(e){const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${o}`}function G(e){const t=new Map;return e.forEach(n=>{t.has(n.dateKey)||t.set(n.dateKey,[]),t.get(n.dateKey).push(n)}),Array.from(t.entries()).sort((n,o)=>n[0]<o[0]?1:-1).map(([n,o])=>({dateKey:n,recs:o}))}function q(e){const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return`${t}:${n}:${o}`}function C(e){if(!e||typeof e!="string")return"";const t=e.split("-");if(t.length<3)return e;const[n,o,s]=t;return`${n}å¹´${Number(o)}æœˆ${Number(s)}æ—¥`}function ue(e){const t=[];let n=0;for(;n<e.length;)if(e[n]==='"'){let o="";for(n++;n<e.length&&(e[n]!=='"'||e[n+1]==='"');)o+=e[n]==='"'&&e[n+1]==='"'?'"':e[n],n++;e[n]==='"'&&n++,t.push(o),e[n]===","&&n++}else{const o=e.indexOf(",",n),s=o===-1?e.slice(n):e.slice(n,o);t.push(s.trim()),n=o===-1?e.length:o+1}return t}function Me(e){return{å¦‚å•:"toilet",é¥­å¦:"meal",å¥èº«:"fitness",å…¶ä»–:"other"}[e]||"other"}function Ce(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);if(!t)return null;const[,n,o,s]=t,a=`${n}-${String(o).padStart(2,"0")}-${String(s).padStart(2,"0")}`,r=/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/.exec(e),p=r?parseInt(r[1],10):12,y=r?parseInt(r[2],10):0,u=r&&r[3]?parseInt(r[3],10):0,f=new Date(parseInt(n,10),parseInt(o,10)-1,parseInt(s,10),p,y,u);return{dateKey:a,timestamp:f.getTime()}}function oe(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);return t?`${t[1]}-${String(t[2]).padStart(2,"0")}-${String(t[3]).padStart(2,"0")}`:null}function ke(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=ue(t[o]);if(s.length<2)continue;const a=s[0].trim(),r=s[1].trim();if(o===0&&(a==="ç±»å‹"||a==="æ—¥æœŸæ—¶é—´"))continue;const p=Me(a),y=Ce(r);y&&n.push({id:`import-${y.timestamp}-${Math.random().toString(36).slice(2,6)}`,timestamp:y.timestamp,dateKey:y.dateKey,type:p})}return n}function we(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=ue(t[o]);if(s.length<2)continue;const a=s[0].trim(),r=s[1].trim();if(o===0&&(a==="å¼€å§‹æ—¥æœŸ"||r==="ç»“æŸæ—¥æœŸ"))continue;const p=oe(a);if(!p)continue;const y=r==="è¿›è¡Œä¸­"||!r?null:oe(r);n.push({id:`p-import-${Date.now()}-${o}-${Math.random().toString(36).slice(2,6)}`,startDate:p,endDate:y||null})}return n}function Te(e){const t=w(new Date);return e.filter(n=>n.dateKey===t).length}function me(e){if(!e.length)return 0;const t=G(e);let n=0,o=new Date,s=w(o);for(let a=0;a<t.length;a++){const{dateKey:r}=t[a];if(r===s)n++,o.setDate(o.getDate()-1),s=w(o);else break}return n}function W(e){switch(e){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function pe(){try{const e=localStorage.getItem(J);if(e&&/^#[0-9A-Fa-f]{6}$/.test(e))return e}catch(e){console.error("Failed to load theme",e)}return null}function se(e){e?localStorage.setItem(J,e):localStorage.removeItem(J)}function fe(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function $e(e,t){const{r:n,g:o,b:s}=fe(e);return"#"+[n,o,s].map(a=>Math.round(Math.max(0,a*(1-t))).toString(16).padStart(2,"0")).join("")}function he(e){const t=document.documentElement;t.classList.forEach(a=>{a.startsWith("theme-day-")&&t.classList.remove(a)}),t.style.setProperty("--primary",e),t.style.setProperty("--primary-dark",$e(e,.15));const{r:n,g:o,b:s}=fe(e);t.style.setProperty("--primary-soft",`rgba(${n}, ${o}, ${s}, 0.15)`)}function ye(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-dark"),e.style.removeProperty("--primary-soft"),e.classList.forEach(n=>{n.startsWith("theme-day-")&&e.classList.remove(n)});const t=new Date().getDay();e.classList.add("theme-day-"+t)}function Ae(){const e=pe();e?he(e):ye()}function ge(){try{const e=localStorage.getItem(de);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Re(e){localStorage.setItem(de,JSON.stringify(e))}function re(e){const t=ge(),n=[];return le.forEach(o=>{t.includes(o.id)||o.check(e)&&(n.push(o),t.push(o.id))}),n.length&&Re(t),n}function xe(e){const t=document.getElementById("achievementToast");if(!t)return;const n=t.querySelector(".achievement-toast-title"),o=t.querySelector(".achievement-toast-icon");n&&(n.textContent="æ­å–œï¼"+e.title),o&&(o.textContent=e.icon),t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),2500)}function Ke(e,t,n){const o=`${t}-${String(n).padStart(2,"0")}`,s={};return e.forEach(a=>{a.dateKey.startsWith(o)&&(s[a.dateKey]=(s[a.dateKey]||0)+1)}),s}function He(e,t){if(!e)return;const n=new Date,o=n.getFullYear(),s=n.getMonth()+1,a=Ke(t,o,s),r=new Date(o,s-1,1),y=new Date(o,s-1+1,0).getDate(),u=r.getDay();let f='<div class="heatmap-grid">';["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(L=>{f+='<span class="heatmap-week-label">'+L+"</span>"});for(let L=0;L<u;L++)f+='<span class="heatmap-cell heatmap-cell-empty"></span>';for(let L=1;L<=y;L++){const D=`${o}-${String(s).padStart(2,"0")}-${String(L).padStart(2,"0")}`,b=a[D]||0;let M="heatmap-cell-0";b>=6?M="heatmap-cell-4":b>=4?M="heatmap-cell-3":b>=2?M="heatmap-cell-2":b>=1&&(M="heatmap-cell-1");const I=b?`${D} æ‰“å¡ ${b} æ¬¡`:D;f+='<span class="heatmap-cell '+M+'" title="'+I+'">'+(b||"")+"</span>"}f+="</div>",e.innerHTML=f}function Pe(e){switch(e){case"toilet":return"ç§‹ç‘¾åˆæ‹‰ç²‘ç²‘å•¦ï½";case"meal":return"ç§‹ç‘¾çœŸä¹–ï¼Œåƒé¥­é¦™é¦™ï½";case"fitness":return"ç§‹ç‘¾å¨æ­¦ï¼ŒèŒå£®æˆé•¿ï½";default:return"ç§‹ç‘¾çœŸæ£’ï½"}}function Fe(e){if(!e)return;e.innerHTML="";const t=["â™¥","âœ¨","â˜…","â˜†","â€¢","â™¥","âœ¨","â˜…"],n=["celebrate-float","celebrate-twinkle","celebrate-rise"],o=["#ff6b9d","#e84c7a","#ffd700","#ffb347","#c2185b","#f8bbd9"],s=28;for(let a=0;a<s;a++){const r=document.createElement("span");r.className="celebrate-item "+n[a%n.length],r.textContent=t[a%t.length],r.style.left=Math.random()*80+10+"%",r.style.top=Math.random()*80+10+"%",r.style.animationDelay=Math.random()*.8+"s",r.style.color=o[a%o.length],r.style.fontSize=12+Math.random()*12+"px",e.appendChild(r)}}function Oe(e,t){const n=new Date,o=w(n);if(t==="today")return e.filter(s=>s.dateKey===o);if(t==="week"){const s=new Date;s.setDate(n.getDate()-6);const a=w(s);return e.filter(r=>r.dateKey>=a)}if(t==="month"){const[s,a]=o.split("-"),r=`${s}-${a}`;return e.filter(p=>p.dateKey.startsWith(r))}return e}function A(e,t="all"){if(Ee.textContent=String(Te(e)),Le.textContent=String(me(e)),!e.length)Q.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const r=e[e.length-1],p=new Date(r.timestamp);Q.textContent=`æœ€åä¸€æ¬¡ï¼š${C(r.dateKey)} ${q(p)}`}const n=Oe(e,t);if(j.innerHTML="",!n.length){j.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const o=document.createDocumentFragment(),s=i.historyType||"all";["toilet","meal","fitness","other"].forEach(r=>{if(s!=="all"&&s!==r)return;const p=n.filter(b=>(b.type||"other")===r);if(!p.length)return;const y=document.createElement("div");y.className=`history-type-block history-type-block-${r}`;const u=document.createElement("div");u.className="history-item";const f=document.createElement("div"),T=document.createElement("div");T.className="history-date",T.textContent=W(r);const L=document.createElement("div");L.className="history-time",L.textContent=`å…± ${p.length} æ¬¡`,f.appendChild(T),f.appendChild(L),u.appendChild(f),y.appendChild(u),G(p.slice().sort((b,M)=>b.timestamp-M.timestamp)).forEach(({dateKey:b,recs:M})=>{const I=document.createElement("div");I.className="history-item";const k=document.createElement("div"),c=document.createElement("div");c.className="history-date",c.textContent=C(b);const d=document.createElement("div");d.className="history-time-list",M.forEach(l=>{const m=new Date(l.timestamp),B=document.createElement("div");B.className="time-chip";const E=document.createElement("span");E.textContent=q(m);const g=document.createElement("button");g.className="time-delete-btn",g.textContent="åˆ ",g.setAttribute("data-id",l.id),B.appendChild(E),B.appendChild(g),d.appendChild(B)}),k.appendChild(c),k.appendChild(d),I.appendChild(k),y.appendChild(I)}),o.appendChild(y)}),j.appendChild(o),He(document.getElementById("heatmapContainer"),i.records)}function ie(){A(i.records,i.filter),R()}let i={records:[],filter:"all",currentType:"fitness",historyType:"all",periodRecords:[],activeTab:"punch"},O=null;function F(e){const{title:t,message:n,onConfirm:o}=e;if(!K){window.confirm(n)&&typeof o=="function"&&o();return}be.textContent=t||"ç¡®è®¤æ“ä½œ",Se.textContent=n||"",O=typeof o=="function"?o:null,K.hidden=!1}function U(){K&&(K.hidden=!0),O=null}function V(e,t){return t?e.filter(n=>(n.type||"other")===t):e}function Ne(){try{const e=localStorage.getItem(ae);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load period records",e),[]}}function P(e){localStorage.setItem(ae,JSON.stringify(e))}function Y(e){return e.filter(t=>!t.endDate).sort((t,n)=>n.startDate>t.startDate?1:-1)[0]||null}function _e(e){const t=e.map(r=>r.startDate).filter(Boolean).sort();if(t.length<2)return null;const n=[];for(let r=1;r<t.length;r++){const p=new Date(t[r-1]),y=new Date(t[r]),u=Math.round((y-p)/(24*60*60*1e3));u>0&&u<90&&n.push(u)}if(!n.length)return null;const o=Math.round(n.reduce((r,p)=>r+p,0)/n.length),s=t[t.length-1],a=new Date(s);return a.setDate(a.getDate()+o),{dateKey:w(a),avgCycle:o}}function R(){const e=document.getElementById("periodStatus"),t=document.getElementById("periodPrediction"),n=document.getElementById("periodHistoryList"),o=document.getElementById("periodStartBtn"),s=document.getElementById("periodEndBtn");if(!e||!t||!n)return;const a=i.periodRecords,r=Y(a);w(new Date),r?(e.innerHTML=`
      <div class="period-status-title">è¿›è¡Œä¸­</div>
      <div>å¼€å§‹ï¼š${C(r.startDate)}</div>
      <div>ç»“æŸï¼šå°šæœªè®°å½•</div>
    `,s&&(s.disabled=!1),o&&(o.disabled=!0)):(e.innerHTML=`
      <div class="period-status-title">æœªåœ¨ç»æœŸ</div>
      <div>è®°å½•ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€å¼€å§‹æ–°å‘¨æœŸ</div>
    `,s&&(s.disabled=!0),o&&(o.disabled=!1));const p=_e(a);p?(t.innerHTML=`
      <div class="period-prediction-title">é¢„è®¡ä¸‹æ¬¡å¼€å§‹</div>
      <div class="period-prediction-value">${C(p.dateKey)}</div>
      <div class="period-prediction-hint">åŸºäºå¹³å‡å‘¨æœŸ ${p.avgCycle} å¤©ï¼Œä»…ä¾›å‚è€ƒ</div>
    `,t.hidden=!1):(t.innerHTML=`
      <div class="period-prediction-title">é¢„æµ‹</div>
      <div class="period-prediction-hint">å†è®°å½•è‡³å°‘ 2 æ¬¡ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€åä¼šæ˜¾ç¤ºé¢„æµ‹</div>
    `,t.hidden=!1);const y=[...a].sort((u,f)=>f.startDate>u.startDate?1:-1);if(!y.length){n.innerHTML='<div class="period-empty">æš‚æ— ç»æœŸè®°å½•</div>';return}n.innerHTML="",y.forEach(u=>{const f=document.createElement("div");f.className="period-history-item";const T=u.endDate?`${C(u.startDate)} ï½ ${C(u.endDate)}`:`${C(u.startDate)} ï½ è¿›è¡Œä¸­`,L=u.endDate?Math.round((new Date(u.endDate)-new Date(u.startDate))/(24*60*60*1e3))+1:"";f.innerHTML=`
      <span class="period-range">${T}</span>
      <span class="period-days">${L?L+" å¤©":""}</span>
      <button type="button" class="period-history-delete" data-period-id="${u.id}">åˆ </button>
    `,n.appendChild(f)})}function Ue(){i.records=Ie(),i.periodRecords=Ne(),Z.forEach(c=>{c.addEventListener("click",()=>{Z.forEach(d=>d.classList.remove("active")),c.classList.add("active"),i.currentType=c.dataset.type||"fitness",A(i.records,i.filter)})});const e=document.querySelector(".type-tab.active");e&&(i.currentType=e.dataset.type||"fitness"),A(i.records,i.filter),re(i.records);const t=document.getElementById("punchSuccessModal"),n=document.getElementById("punchSuccessMessage"),o=document.getElementById("punchSuccessCelebration"),s=document.getElementById("punchSuccessConfirm");N.addEventListener("click",()=>{const c=new Date,d={id:`${c.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:c.getTime(),dateKey:w(c),type:i.currentType};i.records.push(d),_(i.records),t&&n&&(n.textContent=Pe(i.currentType),t.hidden=!1,requestAnimationFrame(()=>Fe(o))),N.classList.remove("punch-button-bounce"),N.offsetWidth,N.classList.add("punch-button-bounce"),setTimeout(()=>{A(i.records,i.filter),re(i.records).forEach(l=>xe(l))},0)}),s&&t&&s.addEventListener("click",()=>{t.hidden=!0}),t&&t.addEventListener("click",c=>{c.target===t&&(t.hidden=!0)});const a=document.getElementById("achievementBtn"),r=document.getElementById("achievementModal");a&&r&&a.addEventListener("click",()=>{const c=document.getElementById("achievementList");if(c){const d=ge();c.innerHTML=le.map(l=>'<div class="achievement-item '+(d.includes(l.id)?"unlocked":"locked")+'"><span class="achievement-icon">'+l.icon+'</span><div class="achievement-info"><span class="achievement-title">'+l.title+'</span><span class="achievement-desc">'+l.desc+"</span></div></div>").join("")}r.hidden=!1});const p=document.getElementById("achievementModalClose");p&&r&&p.addEventListener("click",()=>{r.hidden=!0}),r&&r.addEventListener("click",c=>{c.target===r&&(r.hidden=!0)}),X.forEach(c=>{c.addEventListener("click",()=>{X.forEach(d=>d.classList.remove("active")),c.classList.add("active"),i.filter=c.dataset.filter||"all",A(i.records,i.filter)})}),ee.forEach(c=>{c.addEventListener("click",()=>{ee.forEach(d=>d.classList.remove("active")),c.classList.add("active"),i.historyType=c.dataset.historyType||"all",A(i.records,i.filter)})}),te&&te.addEventListener("click",()=>{U()}),ne&&ne.addEventListener("click",()=>{if(O){const c=O;O=null,U(),c()}else U()}),K&&K.addEventListener("click",c=>{c.target===K&&U()}),j.addEventListener("click",c=>{const d=c.target;if(!(d instanceof HTMLElement)||!d.classList.contains("time-delete-btn"))return;const l=d.getAttribute("data-id");if(!l)return;const m=i.records.find(g=>g.id===l);if(!m)return;const B=W(m.type||"other"),E=new Date(m.timestamp);F({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${B}ã€‘åœ¨ã€${C(m.dateKey)} ${q(E)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{i.records=i.records.filter(g=>g.id!==l),_(i.records),A(i.records,i.filter)}})}),Be.addEventListener("click",()=>{const c=document.getElementById("actionsMenu");if(c&&c.classList.contains("open")&&c.classList.remove("open"),!i.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const d=["ç±»å‹","æ—¥æœŸæ—¶é—´"],l=i.records.slice().sort((v,S)=>v.timestamp-S.timestamp).map(v=>{const S=new Date(v.timestamp),x=`${C(v.dateKey)} ${q(S)}`;return[W(v.type||"other"),x]}),m=[d,...l].map(v=>v.map(S=>`"${S}"`).join(",")).join(`
`),B=new Blob([m],{type:"text/csv;charset=utf-8;"}),E=URL.createObjectURL(B),g=document.createElement("a");g.href=E,g.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${w(new Date)}.csv`,g.click(),URL.revokeObjectURL(E)});const y=document.getElementById("importBtn"),u=document.getElementById("punchFileInput");y&&u&&(y.addEventListener("click",()=>{const c=document.getElementById("actionsMenu");c&&c.classList.contains("open")&&c.classList.remove("open"),u.value="",u.click()}),u.addEventListener("change",()=>{const c=u.files&&u.files[0];if(!c)return;const d=new FileReader;d.onload=()=>{try{let l=typeof d.result=="string"?d.result:"";l=l.replace(/^\uFEFF/,"");const m=ke(l);if(!m.length){alert("æœªè§£æåˆ°æœ‰æ•ˆæ‰“å¡æ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šç±»å‹ã€æ—¥æœŸæ—¶é—´");return}i.records=i.records.concat(m),i.records.sort((B,E)=>B.timestamp-E.timestamp),_(i.records),A(i.records,i.filter),alert("å·²å¯¼å…¥ "+m.length+" æ¡æ‰“å¡è®°å½•")}catch(l){alert("è§£æå¤±è´¥ï¼š"+(l.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ CSV"))}},d.readAsText(c,"UTF-8")})),De.addEventListener("click",()=>{const c=document.getElementById("actionsMenu");c&&c.classList.contains("open")&&c.classList.remove("open"),i.records.length&&F({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{i.records=[],_(i.records),A(i.records,i.filter)}})});const f=document.getElementById("periodStartBtn");f&&f.addEventListener("click",()=>{const c=Y(i.periodRecords),d=w(new Date);if(c){const l=new Date;l.setDate(l.getDate()-1);const m=w(l);F({title:"å¼€å§‹æ–°å‘¨æœŸ",message:"å½“å‰æœ‰ä¸€å‘¨æœŸæœªç»“æŸï¼Œå°†æŠŠä¸Šä¸€å‘¨æœŸç»“æŸæ—¥è®¾ä¸ºæ˜¨å¤©ï¼Œå†è®°å½•æœ¬æ¬¡å¼€å§‹ã€‚ç¡®å®šï¼Ÿ",onConfirm:()=>{c.endDate=m;const B={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:d,endDate:null};i.periodRecords.push(B),P(i.periodRecords),R()}})}else{const l={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:d,endDate:null};i.periodRecords.push(l),P(i.periodRecords),R()}});const T=document.getElementById("periodEndBtn");T&&T.addEventListener("click",()=>{const c=Y(i.periodRecords);if(!c)return;const d=w(new Date);c.endDate=d,P(i.periodRecords),R()});const L=document.getElementById("periodHistoryList");L&&L.addEventListener("click",c=>{const d=c.target;if(!d.classList.contains("period-history-delete"))return;const l=d.getAttribute("data-period-id");if(!l)return;const m=i.periodRecords.find(E=>E.id===l);if(!m)return;const B=m.endDate?`${C(m.startDate)} ï½ ${C(m.endDate)}`:C(m.startDate)+" ï½ è¿›è¡Œä¸­";F({title:"åˆ é™¤ç»æœŸè®°å½•",message:`ç¡®å®šåˆ é™¤ã€Œ${B}ã€è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{i.periodRecords=i.periodRecords.filter(E=>E.id!==l),P(i.periodRecords),R()}})});const D=document.getElementById("periodActionsMenu"),b=document.getElementById("periodExportBtn");b&&b.addEventListener("click",()=>{if(!i.periodRecords.length){alert("æš‚æ— ç»æœŸæ•°æ®å¯å¯¼å‡º");return}const c=["å¼€å§‹æ—¥æœŸ","ç»“æŸæ—¥æœŸ","å¤©æ•°"],d=[...i.periodRecords].sort((g,v)=>v.startDate>g.startDate?1:-1).map(g=>{const v=g.endDate?C(g.endDate):"è¿›è¡Œä¸­",S=g.endDate?String(Math.round((new Date(g.endDate)-new Date(g.startDate))/(24*60*60*1e3))+1):"-";return[C(g.startDate),v,S]}),l=[c,...d].map(g=>g.map(v=>`"${v}"`).join(",")).join(`
`),m=new Blob([l],{type:"text/csv;charset=utf-8;"}),B=URL.createObjectURL(m),E=document.createElement("a");E.href=B,E.download=`ç»æœŸè®°å½•-${w(new Date)}.csv`,E.click(),URL.revokeObjectURL(B),D&&D.classList.remove("open")});const M=document.getElementById("periodClearBtn");M&&M.addEventListener("click",()=>{i.periodRecords.length&&(D&&D.classList.remove("open"),F({title:"æ¸…ç©ºç»æœŸè®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»æœŸè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{i.periodRecords=[],P(i.periodRecords),R()}}))});const I=document.getElementById("periodImportBtn"),k=document.getElementById("periodFileInput");I&&k&&(I.addEventListener("click",()=>{D&&D.classList.remove("open"),k.value="",k.click()}),k.addEventListener("change",()=>{const c=k.files&&k.files[0];if(!c)return;const d=new FileReader;d.onload=()=>{try{let l=typeof d.result=="string"?d.result:"";l=l.replace(/^\uFEFF/,"");const m=we(l);if(!m.length){alert("æœªè§£æåˆ°æœ‰æ•ˆç»æœŸæ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸã€å¤©æ•°");return}i.periodRecords=i.periodRecords.concat(m),i.periodRecords.sort((B,E)=>E.startDate>B.startDate?1:-1),P(i.periodRecords),R(),alert("å·²å¯¼å…¥ "+m.length+" æ¡ç»æœŸè®°å½•")}catch(l){alert("è§£æå¤±è´¥ï¼š"+(l.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ç»æœŸ CSV"))}},d.readAsText(c,"UTF-8")}))}document.addEventListener("DOMContentLoaded",function(){Ae(),Ue(),R();var e=document.getElementById("themeBtn"),t=document.getElementById("themeModal"),n=document.getElementById("themeModalClose"),o=document.getElementById("themeColorInput"),s=document.getElementById("themeResetBtn"),a=document.getElementById("themeHelpBtn"),r=document.getElementById("themeHelpBlock");function p(){var h=pe();h?o.value=h:o.value=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim()||"#6B7FD7",r.hidden=!0,t.hidden=!1}function y(){t.hidden=!0}e&&e.addEventListener("click",p),n&&n.addEventListener("click",y),t&&t.addEventListener("click",function(h){h.target===t&&y()}),o&&o.addEventListener("input",function(){var h=o.value;se(h),he(h)}),s&&s.addEventListener("click",function(){se(null),ye(),y()}),a&&r&&a.addEventListener("click",function(){r.hidden=!r.hidden});var u=document.getElementById("settingsBtn"),f=document.getElementById("settingsModal"),T=document.getElementById("settingsModalClose"),L=document.getElementById("aboutBtn"),D=document.getElementById("aboutModal"),b=document.getElementById("aboutModalClose"),M=document.getElementById("helpBtn"),I=document.getElementById("helpModal"),k=document.getElementById("helpModalClose");function c(){f&&(f.hidden=!1)}function d(){f&&(f.hidden=!0)}function l(){d(),D&&(D.hidden=!1)}function m(){D&&(D.hidden=!0)}function B(){d(),I&&(I.hidden=!1)}function E(){I&&(I.hidden=!0)}u&&u.addEventListener("click",c),T&&T.addEventListener("click",d),f&&f.addEventListener("click",function(h){h.target===f&&d()}),L&&L.addEventListener("click",l),b&&b.addEventListener("click",m),D&&D.addEventListener("click",function(h){h.target===D&&m()}),M&&M.addEventListener("click",B),k&&k.addEventListener("click",E),I&&I.addEventListener("click",function(h){h.target===I&&E()});var g=document.getElementById("actionsFabToggle"),v=document.getElementById("actionsMenu"),S=document.getElementById("periodActionsMenu");g&&v&&S&&(g.addEventListener("click",function(){var h=i.activeTab==="punch"?v:S,$=i.activeTab==="punch"?S:v;$.classList.remove("open"),h.classList.toggle("open")}),document.addEventListener("click",function(h){g.contains(h.target)||v.contains(h.target)||S.contains(h.target)||(v.classList.contains("open")||S.classList.contains("open"))&&(v.classList.remove("open"),S.classList.remove("open"))}));var x=document.getElementById("panelPunch"),H=document.getElementById("panelPeriod"),z=document.querySelectorAll(".tab-bar-item");document.getElementById("actionsFab");function ve(h){i.activeTab=h,v&&v.classList.contains("open")&&v.classList.remove("open"),S&&S.classList.contains("open")&&S.classList.remove("open"),h==="punch"?(x&&(x.classList.add("active"),x.removeAttribute("hidden")),H&&(H.classList.remove("active"),H.hidden=!0)):(x&&(x.classList.remove("active"),x.hidden=!0),H&&(H.classList.add("active"),H.removeAttribute("hidden")),R()),z.forEach(function($){$.getAttribute("data-tab")===h?($.classList.add("active"),$.setAttribute("aria-selected","true")):($.classList.remove("active"),$.setAttribute("aria-selected","false"))})}z.forEach(function(h){h.addEventListener("click",function(){var $=h.getAttribute("data-tab");$&&ve($)})}),document.addEventListener("visibilitychange",function(){document.visibilityState==="visible"&&ie()}),window.addEventListener("pageshow",function(h){h.persisted&&ie()})});
