(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const A=document.getElementById("punchBtn"),me=document.getElementById("todayCount"),ue=document.getElementById("streakCount"),J=document.getElementById("lastPunchTime"),H=document.getElementById("historyList"),W=document.querySelectorAll(".filter-tab"),pe=document.getElementById("exportBtn"),fe=document.getElementById("clearBtn"),Y=document.querySelectorAll(".type-tab"),G=document.querySelectorAll(".history-type-tab"),k=document.getElementById("confirmModal"),he=document.getElementById("modalTitle"),ye=document.getElementById("modalMessage"),z=document.getElementById("modalCancel"),Q=document.getElementById("modalConfirm"),te="punch_records_v1",ne="punch_period_records_v1",_="punch_theme_v1",oe="punch_achievements_v1",re=[{id:"streak7",title:"è¿ç»­ 7 å¤©",desc:"è¿ç»­æ‰“å¡æ»¡ 7 å¤©",icon:"ğŸ”¥",check:e=>ie(e)>=7},{id:"toilet30",title:"å¦‚å•è¾¾äºº",desc:"å¦‚å•æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš½",check:e=>N(e,"toilet").length>=30},{id:"meal30",title:"é¥­å¦è¾¾äºº",desc:"é¥­å¦æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸš",check:e=>N(e,"meal").length>=30},{id:"fitness30",title:"å¥èº«è¾¾äºº",desc:"å¥èº«æ‰“å¡æ»¡ 30 æ¬¡",icon:"ğŸ’ª",check:e=>N(e,"fitness").length>=30},{id:"days100",title:"åšæŒ 100 å¤©",desc:"ä½¿ç”¨æ‰“å¡æ»¡ 100 å¤©",icon:"ğŸ“…",check:e=>{if(!e.length)return!1;const t=e.slice().sort((o,s)=>o.timestamp-s.timestamp)[0];return Math.floor((Date.now()-t.timestamp)/(24*60*60*1e3))>=100}},{id:"all4",title:"å…¨èƒ½æ—¥",desc:"åŒä¸€å¤©æ‰“è¿‡å…¨éƒ¨ 4 ç§ç±»å‹",icon:"ğŸŒŸ",check:e=>q(e).some(({recs:n})=>new Set(n.map(s=>s.type||"other")).size>=4)}];function ge(){try{const e=localStorage.getItem(te);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load records",e),[]}}function K(e){localStorage.setItem(te,JSON.stringify(e))}function C(e){return e.toISOString().slice(0,10)}function q(e){const t=new Map;return e.forEach(n=>{t.has(n.dateKey)||t.set(n.dateKey,[]),t.get(n.dateKey).push(n)}),Array.from(t.entries()).sort((n,o)=>n[0]<o[0]?1:-1).map(([n,o])=>({dateKey:n,recs:o}))}function O(e){const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return`${t}:${n}:${o}`}function b(e){const[t,n,o]=e.split("-");return`${t}å¹´${Number(n)}æœˆ${Number(o)}æ—¥`}function se(e){const t=[];let n=0;for(;n<e.length;)if(e[n]==='"'){let o="";for(n++;n<e.length&&(e[n]!=='"'||e[n+1]==='"');)o+=e[n]==='"'&&e[n+1]==='"'?'"':e[n],n++;e[n]==='"'&&n++,t.push(o),e[n]===","&&n++}else{const o=e.indexOf(",",n),s=o===-1?e.slice(n):e.slice(n,o);t.push(s.trim()),n=o===-1?e.length:o+1}return t}function ve(e){return{å¦‚å•:"toilet",é¥­å¦:"meal",å¥èº«:"fitness",å…¶ä»–:"other"}[e]||"other"}function Ee(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);if(!t)return null;const[,n,o,s]=t,a=`${n}-${String(o).padStart(2,"0")}-${String(s).padStart(2,"0")}`,i=/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/.exec(e),u=i?parseInt(i[1],10):12,f=i?parseInt(i[2],10):0,m=i&&i[3]?parseInt(i[3],10):0,h=new Date(parseInt(n,10),parseInt(o,10)-1,parseInt(s,10),u,f,m);return{dateKey:a,timestamp:h.getTime()}}function X(e){const t=/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/.exec(e);return t?`${t[1]}-${String(t[2]).padStart(2,"0")}-${String(t[3]).padStart(2,"0")}`:null}function Le(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=se(t[o]);if(s.length<2)continue;const a=s[0].trim(),i=s[1].trim();if(o===0&&(a==="ç±»å‹"||a==="æ—¥æœŸæ—¶é—´"))continue;const u=ve(a),f=Ee(i);f&&n.push({id:`import-${f.timestamp}-${Math.random().toString(36).slice(2,6)}`,timestamp:f.timestamp,dateKey:f.dateKey,type:u})}return n}function De(e){const t=e.split(/\r?\n/).filter(o=>o.trim()),n=[];for(let o=0;o<t.length;o++){const s=se(t[o]);if(s.length<2)continue;const a=s[0].trim(),i=s[1].trim();if(o===0&&(a==="å¼€å§‹æ—¥æœŸ"||i==="ç»“æŸæ—¥æœŸ"))continue;const u=X(a);if(!u)continue;const f=i==="è¿›è¡Œä¸­"||!i?null:X(i);n.push({id:`p-import-${Date.now()}-${o}-${Math.random().toString(36).slice(2,6)}`,startDate:u,endDate:f||null})}return n}function Be(e){const t=C(new Date);return e.filter(n=>n.dateKey===t).length}function ie(e){if(!e.length)return 0;const t=q(e);let n=0,o=new Date,s=C(o);for(let a=0;a<t.length;a++){const{dateKey:i}=t[a];if(i===s)n++,o.setDate(o.getDate()-1),s=C(o);else break}return n}function U(e){switch(e){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function ce(){try{const e=localStorage.getItem(_);if(e&&/^#[0-9A-Fa-f]{6}$/.test(e))return e}catch(e){console.error("Failed to load theme",e)}return null}function Z(e){e?localStorage.setItem(_,e):localStorage.removeItem(_)}function ae(e){const t=parseInt(e.slice(1),16);return{r:t>>16&255,g:t>>8&255,b:t&255}}function Se(e,t){const{r:n,g:o,b:s}=ae(e);return"#"+[n,o,s].map(a=>Math.round(Math.max(0,a*(1-t))).toString(16).padStart(2,"0")).join("")}function de(e){const t=document.documentElement;t.classList.forEach(a=>{a.startsWith("theme-day-")&&t.classList.remove(a)}),t.style.setProperty("--primary",e),t.style.setProperty("--primary-dark",Se(e,.15));const{r:n,g:o,b:s}=ae(e);t.style.setProperty("--primary-soft",`rgba(${n}, ${o}, ${s}, 0.15)`)}function le(){const e=document.documentElement;e.style.removeProperty("--primary"),e.style.removeProperty("--primary-dark"),e.style.removeProperty("--primary-soft"),e.classList.forEach(n=>{n.startsWith("theme-day-")&&e.classList.remove(n)});const t=new Date().getDay();e.classList.add("theme-day-"+t)}function be(){const e=ce();e?de(e):le()}function V(){try{const e=localStorage.getItem(oe);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Ie(e){localStorage.setItem(oe,JSON.stringify(e))}function ee(e){const t=V(),n=[];return re.forEach(o=>{t.includes(o.id)||o.check(e)&&(n.push(o),t.push(o.id))}),n.length&&Ie(t),n}function Ce(e){const t=document.getElementById("achievementToast");if(!t)return;const n=t.querySelector(".achievement-toast-title"),o=t.querySelector(".achievement-toast-icon");n&&(n.textContent="æ­å–œï¼"+e.title),o&&(o.textContent=e.icon),t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),2500)}function Te(e,t,n){const o=`${t}-${String(n).padStart(2,"0")}`,s={};return e.forEach(a=>{a.dateKey.startsWith(o)&&(s[a.dateKey]=(s[a.dateKey]||0)+1)}),s}function we(e,t){if(!e)return;const n=new Date,o=n.getFullYear(),s=n.getMonth()+1,a=Te(t,o,s),i=new Date(o,s-1,1),f=new Date(o,s-1+1,0).getDate(),m=i.getDay();let h='<div class="heatmap-grid">';["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(y=>{h+='<span class="heatmap-week-label">'+y+"</span>"});for(let y=0;y<m;y++)h+='<span class="heatmap-cell heatmap-cell-empty"></span>';for(let y=1;y<=f;y++){const I=`${o}-${String(s).padStart(2,"0")}-${String(y).padStart(2,"0")}`,S=a[I]||0;let g="heatmap-cell-0";S>=6?g="heatmap-cell-4":S>=4?g="heatmap-cell-3":S>=2?g="heatmap-cell-2":S>=1&&(g="heatmap-cell-1");const r=S?`${I} æ‰“å¡ ${S} æ¬¡`:I;h+='<span class="heatmap-cell '+g+'" title="'+r+'">'+(S||"")+"</span>"}h+="</div>",e.innerHTML=h}function Me(e){switch(e){case"toilet":return"ç§‹ç‘¾åˆæ‹‰ç²‘ç²‘å•¦ï½";case"meal":return"ç§‹ç‘¾çœŸä¹–ï¼Œåƒé¥­é¦™é¦™ï½";case"fitness":return"ç§‹ç‘¾å¨æ­¦ï¼ŒèŒå£®æˆé•¿ï½";default:return"ç§‹ç‘¾çœŸæ£’ï½"}}function ke(e){if(!e)return;e.innerHTML="";const t=["â™¥","âœ¨","â˜…","â˜†","â€¢","â™¥","âœ¨","â˜…"],n=["celebrate-float","celebrate-twinkle","celebrate-rise"],o=["#ff6b9d","#e84c7a","#ffd700","#ffb347","#c2185b","#f8bbd9"],s=28;for(let a=0;a<s;a++){const i=document.createElement("span");i.className="celebrate-item "+n[a%n.length],i.textContent=t[a%t.length],i.style.left=Math.random()*80+10+"%",i.style.top=Math.random()*80+10+"%",i.style.animationDelay=Math.random()*.8+"s",i.style.color=o[a%o.length],i.style.fontSize=12+Math.random()*12+"px",e.appendChild(i)}}function $e(e,t){const n=new Date,o=C(n);if(t==="today")return e.filter(s=>s.dateKey===o);if(t==="week"){const s=new Date;s.setDate(n.getDate()-6);const a=C(s);return e.filter(i=>i.dateKey>=a)}if(t==="month"){const[s,a]=o.split("-"),i=`${s}-${a}`;return e.filter(u=>u.dateKey.startsWith(i))}return e}function w(e,t="all"){if(me.textContent=String(Be(e)),ue.textContent=String(ie(e)),!e.length)J.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const u=e[e.length-1],f=new Date(u.timestamp);J.textContent=`æœ€åä¸€æ¬¡ï¼š${b(u.dateKey)} ${O(f)}`}const n=$e(e,t);if(H.innerHTML="",!n.length){H.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const o=document.createDocumentFragment(),s=c.historyType||"all";["toilet","meal","fitness","other"].forEach(u=>{if(s!=="all"&&s!==u)return;const f=n.filter(g=>(g.type||"other")===u);if(!f.length)return;const m=document.createElement("div");m.className=`history-type-block history-type-block-${u}`;const h=document.createElement("div");h.className="history-item";const B=document.createElement("div"),y=document.createElement("div");y.className="history-date",y.textContent=U(u);const I=document.createElement("div");I.className="history-time",I.textContent=`å…± ${f.length} æ¬¡`,B.appendChild(y),B.appendChild(I),h.appendChild(B),m.appendChild(h),q(f.slice().sort((g,r)=>g.timestamp-r.timestamp)).forEach(({dateKey:g,recs:r})=>{const d=document.createElement("div");d.className="history-item";const l=document.createElement("div"),p=document.createElement("div");p.className="history-date",p.textContent=b(g);const L=document.createElement("div");L.className="history-time-list",r.forEach(E=>{const v=new Date(E.timestamp),D=document.createElement("div");D.className="time-chip";const T=document.createElement("span");T.textContent=O(v);const $=document.createElement("button");$.className="time-delete-btn",$.textContent="åˆ ",$.setAttribute("data-id",E.id),D.appendChild(T),D.appendChild($),L.appendChild(D)}),l.appendChild(p),l.appendChild(L),d.appendChild(l),m.appendChild(d)}),o.appendChild(m)}),H.appendChild(o),we(document.getElementById("heatmapContainer"),c.records);const i=document.getElementById("achievementCount");i&&(i.textContent=String(V().length))}let c={records:[],filter:"all",currentType:"fitness",historyType:"all",periodRecords:[],activeTab:"punch"},R=null;function P(e){const{title:t,message:n,onConfirm:o}=e;if(!k){window.confirm(n)&&typeof o=="function"&&o();return}he.textContent=t||"ç¡®è®¤æ“ä½œ",ye.textContent=n||"",R=typeof o=="function"?o:null,k.hidden=!1}function F(){k&&(k.hidden=!0),R=null}function N(e,t){return t?e.filter(n=>(n.type||"other")===t):e}function xe(){try{const e=localStorage.getItem(ne);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return console.error("Failed to load period records",e),[]}}function x(e){localStorage.setItem(ne,JSON.stringify(e))}function j(e){return e.filter(t=>!t.endDate).sort((t,n)=>n.startDate>t.startDate?1:-1)[0]||null}function Re(e){const t=e.map(i=>i.startDate).filter(Boolean).sort();if(t.length<2)return null;const n=[];for(let i=1;i<t.length;i++){const u=new Date(t[i-1]),f=new Date(t[i]),m=Math.round((f-u)/(24*60*60*1e3));m>0&&m<90&&n.push(m)}if(!n.length)return null;const o=Math.round(n.reduce((i,u)=>i+u,0)/n.length),s=t[t.length-1],a=new Date(s);return a.setDate(a.getDate()+o),{dateKey:C(a),avgCycle:o}}function M(){const e=document.getElementById("periodStatus"),t=document.getElementById("periodPrediction"),n=document.getElementById("periodHistoryList"),o=document.getElementById("periodStartBtn"),s=document.getElementById("periodEndBtn");if(!e||!t||!n)return;const a=c.periodRecords,i=j(a);C(new Date),i?(e.innerHTML=`
      <div class="period-status-title">è¿›è¡Œä¸­</div>
      <div>å¼€å§‹ï¼š${b(i.startDate)}</div>
      <div>ç»“æŸï¼šå°šæœªè®°å½•</div>
    `,s&&(s.disabled=!1),o&&(o.disabled=!0)):(e.innerHTML=`
      <div class="period-status-title">æœªåœ¨ç»æœŸ</div>
      <div>è®°å½•ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€å¼€å§‹æ–°å‘¨æœŸ</div>
    `,s&&(s.disabled=!0),o&&(o.disabled=!1));const u=Re(a);u?(t.innerHTML=`
      <div class="period-prediction-title">é¢„è®¡ä¸‹æ¬¡å¼€å§‹</div>
      <div class="period-prediction-value">${b(u.dateKey)}</div>
      <div class="period-prediction-hint">åŸºäºå¹³å‡å‘¨æœŸ ${u.avgCycle} å¤©ï¼Œä»…ä¾›å‚è€ƒ</div>
    `,t.hidden=!1):(t.innerHTML=`
      <div class="period-prediction-title">é¢„æµ‹</div>
      <div class="period-prediction-hint">å†è®°å½•è‡³å°‘ 2 æ¬¡ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€åä¼šæ˜¾ç¤ºé¢„æµ‹</div>
    `,t.hidden=!1);const f=[...a].sort((m,h)=>h.startDate>m.startDate?1:-1);if(!f.length){n.innerHTML='<div class="period-empty">æš‚æ— ç»æœŸè®°å½•</div>';return}n.innerHTML="",f.forEach(m=>{const h=document.createElement("div");h.className="period-history-item";const B=m.endDate?`${b(m.startDate)} ï½ ${b(m.endDate)}`:`${b(m.startDate)} ï½ è¿›è¡Œä¸­`,y=m.endDate?Math.round((new Date(m.endDate)-new Date(m.startDate))/(24*60*60*1e3))+1:"";h.innerHTML=`
      <span class="period-range">${B}</span>
      <span class="period-days">${y?y+" å¤©":""}</span>
      <button type="button" class="period-history-delete" data-period-id="${m.id}">åˆ </button>
    `,n.appendChild(h)})}function Ae(){c.records=ge(),c.periodRecords=xe(),Y.forEach(r=>{r.addEventListener("click",()=>{Y.forEach(d=>d.classList.remove("active")),r.classList.add("active"),c.currentType=r.dataset.type||"fitness",w(c.records,c.filter)})});const e=document.querySelector(".type-tab.active");e&&(c.currentType=e.dataset.type||"fitness"),w(c.records,c.filter),ee(c.records);const t=document.getElementById("punchSuccessModal"),n=document.getElementById("punchSuccessMessage"),o=document.getElementById("punchSuccessCelebration"),s=document.getElementById("punchSuccessConfirm");A.addEventListener("click",()=>{const r=new Date,d={id:`${r.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:r.getTime(),dateKey:C(r),type:c.currentType};c.records.push(d),K(c.records),t&&n&&(n.textContent=Me(c.currentType),t.hidden=!1,requestAnimationFrame(()=>ke(o))),A.classList.remove("punch-button-bounce"),A.offsetWidth,A.classList.add("punch-button-bounce"),setTimeout(()=>{w(c.records,c.filter),ee(c.records).forEach(l=>Ce(l))},0)}),s&&t&&s.addEventListener("click",()=>{t.hidden=!0}),t&&t.addEventListener("click",r=>{r.target===t&&(t.hidden=!0)});const a=document.getElementById("achievementBtn"),i=document.getElementById("achievementModal");a&&i&&a.addEventListener("click",()=>{const r=document.getElementById("achievementList");if(r){const d=V();r.innerHTML=re.map(l=>'<div class="achievement-item '+(d.includes(l.id)?"unlocked":"locked")+'"><span class="achievement-icon">'+l.icon+'</span><div class="achievement-info"><span class="achievement-title">'+l.title+'</span><span class="achievement-desc">'+l.desc+"</span></div></div>").join("")}i.hidden=!1});const u=document.getElementById("achievementModalClose");u&&i&&u.addEventListener("click",()=>{i.hidden=!0}),i&&i.addEventListener("click",r=>{r.target===i&&(i.hidden=!0)}),W.forEach(r=>{r.addEventListener("click",()=>{W.forEach(d=>d.classList.remove("active")),r.classList.add("active"),c.filter=r.dataset.filter||"all",w(c.records,c.filter)})}),G.forEach(r=>{r.addEventListener("click",()=>{G.forEach(d=>d.classList.remove("active")),r.classList.add("active"),c.historyType=r.dataset.historyType||"all",w(c.records,c.filter)})}),z&&z.addEventListener("click",()=>{F()}),Q&&Q.addEventListener("click",()=>{if(R){const r=R;R=null,F(),r()}else F()}),k&&k.addEventListener("click",r=>{r.target===k&&F()}),H.addEventListener("click",r=>{const d=r.target;if(!(d instanceof HTMLElement)||!d.classList.contains("time-delete-btn"))return;const l=d.getAttribute("data-id");if(!l)return;const p=c.records.find(v=>v.id===l);if(!p)return;const L=U(p.type||"other"),E=new Date(p.timestamp);P({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${L}ã€‘åœ¨ã€${b(p.dateKey)} ${O(E)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{c.records=c.records.filter(v=>v.id!==l),K(c.records),w(c.records,c.filter)}})}),pe.addEventListener("click",()=>{const r=document.getElementById("actionsMenu");if(r&&r.classList.contains("open")&&r.classList.remove("open"),!c.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const d=["ç±»å‹","æ—¥æœŸæ—¶é—´"],l=c.records.slice().sort((D,T)=>D.timestamp-T.timestamp).map(D=>{const T=new Date(D.timestamp),$=`${b(D.dateKey)} ${O(T)}`;return[U(D.type||"other"),$]}),p=[d,...l].map(D=>D.map(T=>`"${T}"`).join(",")).join(`
`),L=new Blob([p],{type:"text/csv;charset=utf-8;"}),E=URL.createObjectURL(L),v=document.createElement("a");v.href=E,v.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${C(new Date)}.csv`,v.click(),URL.revokeObjectURL(E)});const f=document.getElementById("importBtn"),m=document.getElementById("punchFileInput");f&&m&&(f.addEventListener("click",()=>{const r=document.getElementById("actionsMenu");r&&r.classList.contains("open")&&r.classList.remove("open"),m.value="",m.click()}),m.addEventListener("change",()=>{const r=m.files&&m.files[0];if(!r)return;const d=new FileReader;d.onload=()=>{try{let l=typeof d.result=="string"?d.result:"";l=l.replace(/^\uFEFF/,"");const p=Le(l);if(!p.length){alert("æœªè§£æåˆ°æœ‰æ•ˆæ‰“å¡æ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šç±»å‹ã€æ—¥æœŸæ—¶é—´");return}c.records=c.records.concat(p),c.records.sort((L,E)=>L.timestamp-E.timestamp),K(c.records),w(c.records,c.filter),alert("å·²å¯¼å…¥ "+p.length+" æ¡æ‰“å¡è®°å½•")}catch(l){alert("è§£æå¤±è´¥ï¼š"+(l.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ CSV"))}},d.readAsText(r,"UTF-8")})),fe.addEventListener("click",()=>{const r=document.getElementById("actionsMenu");r&&r.classList.contains("open")&&r.classList.remove("open"),c.records.length&&P({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{c.records=[],K(c.records),w(c.records,c.filter)}})});const h=document.getElementById("periodStartBtn");h&&h.addEventListener("click",()=>{const r=j(c.periodRecords),d=C(new Date);if(r){const l=new Date;l.setDate(l.getDate()-1);const p=C(l);P({title:"å¼€å§‹æ–°å‘¨æœŸ",message:"å½“å‰æœ‰ä¸€å‘¨æœŸæœªç»“æŸï¼Œå°†æŠŠä¸Šä¸€å‘¨æœŸç»“æŸæ—¥è®¾ä¸ºæ˜¨å¤©ï¼Œå†è®°å½•æœ¬æ¬¡å¼€å§‹ã€‚ç¡®å®šï¼Ÿ",onConfirm:()=>{r.endDate=p;const L={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:d,endDate:null};c.periodRecords.push(L),x(c.periodRecords),M()}})}else{const l={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:d,endDate:null};c.periodRecords.push(l),x(c.periodRecords),M()}});const B=document.getElementById("periodEndBtn");B&&B.addEventListener("click",()=>{const r=j(c.periodRecords);if(!r)return;const d=C(new Date);r.endDate=d,x(c.periodRecords),M()});const y=document.getElementById("periodHistoryList");y&&y.addEventListener("click",r=>{const d=r.target;if(!d.classList.contains("period-history-delete"))return;const l=d.getAttribute("data-period-id");if(!l)return;const p=c.periodRecords.find(E=>E.id===l);if(!p)return;const L=p.endDate?`${b(p.startDate)} ï½ ${b(p.endDate)}`:b(p.startDate)+" ï½ è¿›è¡Œä¸­";P({title:"åˆ é™¤ç»æœŸè®°å½•",message:`ç¡®å®šåˆ é™¤ã€Œ${L}ã€è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{c.periodRecords=c.periodRecords.filter(E=>E.id!==l),x(c.periodRecords),M()}})});const I=document.getElementById("periodExportBtn");I&&I.addEventListener("click",()=>{if(!c.periodRecords.length){alert("æš‚æ— ç»æœŸæ•°æ®å¯å¯¼å‡º");return}const r=["å¼€å§‹æ—¥æœŸ","ç»“æŸæ—¥æœŸ","å¤©æ•°"],d=[...c.periodRecords].sort((v,D)=>D.startDate>v.startDate?1:-1).map(v=>{const D=v.endDate?b(v.endDate):"è¿›è¡Œä¸­",T=v.endDate?String(Math.round((new Date(v.endDate)-new Date(v.startDate))/(24*60*60*1e3))+1):"-";return[b(v.startDate),D,T]}),l=[r,...d].map(v=>v.map(D=>`"${D}"`).join(",")).join(`
`),p=new Blob([l],{type:"text/csv;charset=utf-8;"}),L=URL.createObjectURL(p),E=document.createElement("a");E.href=L,E.download=`ç»æœŸè®°å½•-${C(new Date)}.csv`,E.click(),URL.revokeObjectURL(L)});const S=document.getElementById("periodImportBtn"),g=document.getElementById("periodFileInput");S&&g&&(S.addEventListener("click",()=>{g.value="",g.click()}),g.addEventListener("change",()=>{const r=g.files&&g.files[0];if(!r)return;const d=new FileReader;d.onload=()=>{try{let l=typeof d.result=="string"?d.result:"";l=l.replace(/^\uFEFF/,"");const p=De(l);if(!p.length){alert("æœªè§£æåˆ°æœ‰æ•ˆç»æœŸæ•°æ®ï¼Œè¯·ç¡®è®¤ CSV æ ¼å¼ä¸ºï¼šå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸã€å¤©æ•°");return}c.periodRecords=c.periodRecords.concat(p),c.periodRecords.sort((L,E)=>E.startDate>L.startDate?1:-1),x(c.periodRecords),M(),alert("å·²å¯¼å…¥ "+p.length+" æ¡ç»æœŸè®°å½•")}catch(l){alert("è§£æå¤±è´¥ï¼š"+(l.message||"è¯·ç¡®è®¤æ–‡ä»¶ä¸ºæœ¬åº”ç”¨å¯¼å‡ºçš„ç»æœŸ CSV"))}},d.readAsText(r,"UTF-8")}))}document.addEventListener("DOMContentLoaded",function(){be(),Ae(),M();var e=document.getElementById("themeBtn"),t=document.getElementById("themeModal"),n=document.getElementById("themeModalClose"),o=document.getElementById("themeColorInput"),s=document.getElementById("themeResetBtn"),a=document.getElementById("themeHelpBtn"),i=document.getElementById("themeHelpBlock");function u(){var r=ce();r?o.value=r:o.value=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim()||"#6B7FD7",i.hidden=!0,t.hidden=!1}function f(){t.hidden=!0}e&&e.addEventListener("click",u),n&&n.addEventListener("click",f),t&&t.addEventListener("click",function(r){r.target===t&&f()}),o&&o.addEventListener("input",function(){var r=o.value;Z(r),de(r)}),s&&s.addEventListener("click",function(){Z(null),le(),f()}),a&&i&&a.addEventListener("click",function(){i.hidden=!i.hidden});var m=document.getElementById("actionsFabToggle"),h=document.getElementById("actionsMenu");m&&h&&(m.addEventListener("click",function(){h.classList.toggle("open")}),document.addEventListener("click",function(r){h.classList.contains("open")&&!m.contains(r.target)&&!h.contains(r.target)&&h.classList.remove("open")}));var B=document.getElementById("panelPunch"),y=document.getElementById("panelPeriod"),I=document.querySelectorAll(".tab-bar-item"),S=document.getElementById("actionsFab");function g(r){c.activeTab=r,r==="punch"?(B&&(B.classList.add("active"),B.removeAttribute("hidden")),y&&(y.classList.remove("active"),y.hidden=!0),S&&S.classList.remove("tab-period-hidden")):(B&&(B.classList.remove("active"),B.hidden=!0),y&&(y.classList.add("active"),y.removeAttribute("hidden")),S&&S.classList.add("tab-period-hidden"),M()),I.forEach(function(d){d.getAttribute("data-tab")===r?(d.classList.add("active"),d.setAttribute("aria-selected","true")):(d.classList.remove("active"),d.setAttribute("aria-selected","false"))})}I.forEach(function(r){r.addEventListener("click",function(){var d=r.getAttribute("data-tab");d&&g(d)})})});
