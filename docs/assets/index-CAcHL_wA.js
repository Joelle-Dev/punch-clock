(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function o(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(e){if(e.ep)return;e.ep=!0;const r=o(e);fetch(e.href,r)}})();const B=document.getElementById("punchBtn"),Z=document.getElementById("todayCount"),ee=document.getElementById("streakCount"),_=document.getElementById("lastPunchTime"),S=document.getElementById("historyList"),q=document.querySelectorAll(".filter-tab"),te=document.getElementById("exportBtn"),ne=document.getElementById("clearBtn"),j=document.querySelectorAll(".type-tab"),J=document.querySelectorAll(".history-type-tab"),g=document.getElementById("confirmModal"),re=document.getElementById("modalTitle"),oe=document.getElementById("modalMessage"),U=document.getElementById("modalCancel"),W=document.getElementById("modalConfirm"),C=document.getElementById("praiseWrap"),G=document.getElementById("praiseText"),A=document.getElementById("praiseHearts"),Y="punch_records_v1",z="punch_period_records_v1";function se(){try{const t=localStorage.getItem(Y);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n:[]}catch(t){return console.error("Failed to load records",t),[]}}function N(t){localStorage.setItem(Y,JSON.stringify(t))}function f(t){return t.toISOString().slice(0,10)}function Q(t){const n=new Map;return t.forEach(o=>{n.has(o.dateKey)||n.set(o.dateKey,[]),n.get(o.dateKey).push(o)}),Array.from(n.entries()).sort((o,a)=>o[0]<a[0]?1:-1).map(([o,a])=>({dateKey:o,recs:a}))}function $(t){const n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return`${n}:${o}:${a}`}function y(t){const[n,o,a]=t.split("-");return`${n}å¹´${Number(o)}æœˆ${Number(a)}æ—¥`}function ie(t){const n=f(new Date);return t.filter(o=>o.dateKey===n).length}function ae(t){if(!t.length)return 0;const n=Q(t);let o=0,a=new Date,e=f(a);for(let r=0;r<n.length;r++){const{dateKey:s}=n[r];if(s===e)o++,a.setDate(a.getDate()-1),e=f(a);else break}return o}function V(t){switch(t){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function ce(t,n){const o=new Date,a=f(o);if(n==="today")return t.filter(e=>e.dateKey===a);if(n==="week"){const e=new Date;e.setDate(o.getDate()-6);const r=f(e);return t.filter(s=>s.dateKey>=r)}if(n==="month"){const[e,r]=a.split("-"),s=`${e}-${r}`;return t.filter(c=>c.dateKey.startsWith(s))}return t}function h(t,n="all"){if(Z.textContent=String(ie(t)),ee.textContent=String(ae(t)),!t.length)_.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const s=t[t.length-1],c=new Date(s.timestamp);_.textContent=`æœ€åä¸€æ¬¡ï¼š${y(s.dateKey)} ${$(c)}`}const o=ce(t,n);if(S.innerHTML="",!o.length){S.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const a=document.createDocumentFragment(),e=i.historyType||"all";["toilet","meal","fitness","other"].forEach(s=>{if(e!=="all"&&e!==s)return;const c=o.filter(E=>(E.type||"other")===s);if(!c.length)return;const d=document.createElement("div");d.className=`history-type-block history-type-block-${s}`;const l=document.createElement("div");l.className="history-item";const u=document.createElement("div"),p=document.createElement("div");p.className="history-date",p.textContent=V(s);const m=document.createElement("div");m.className="history-time",m.textContent=`å…± ${c.length} æ¬¡`,u.appendChild(p),u.appendChild(m),l.appendChild(u),d.appendChild(l),Q(c.slice().sort((E,M)=>E.timestamp-M.timestamp)).forEach(({dateKey:E,recs:M})=>{const x=document.createElement("div");x.className="history-item";const K=document.createElement("div"),P=document.createElement("div");P.className="history-date",P.textContent=y(E);const k=document.createElement("div");k.className="history-time-list",M.forEach(H=>{const X=new Date(H.timestamp),D=document.createElement("div");D.className="time-chip";const F=document.createElement("span");F.textContent=$(X);const b=document.createElement("button");b.className="time-delete-btn",b.textContent="åˆ ",b.setAttribute("data-id",H.id),D.appendChild(F),D.appendChild(b),k.appendChild(D)}),K.appendChild(P),K.appendChild(k),x.appendChild(K),d.appendChild(x)}),a.appendChild(d)}),S.appendChild(a)}let i={records:[],filter:"all",currentType:"fitness",historyType:"all",periodRecords:[],activeTab:"punch"},L=null,R=null;function T(t){const{title:n,message:o,onConfirm:a}=t;if(!g){window.confirm(o)&&typeof a=="function"&&a();return}re.textContent=n||"ç¡®è®¤æ“ä½œ",oe.textContent=o||"",L=typeof a=="function"?a:null,g.hidden=!1}function w(){g&&(g.hidden=!0),L=null}function de(){try{const t=localStorage.getItem(z);if(!t)return[];const n=JSON.parse(t);return Array.isArray(n)?n:[]}catch(t){return console.error("Failed to load period records",t),[]}}function I(t){localStorage.setItem(z,JSON.stringify(t))}function O(t){return t.filter(n=>!n.endDate).sort((n,o)=>o.startDate>n.startDate?1:-1)[0]||null}function le(t){const n=t.map(s=>s.startDate).filter(Boolean).sort();if(n.length<2)return null;const o=[];for(let s=1;s<n.length;s++){const c=new Date(n[s-1]),d=new Date(n[s]),l=Math.round((d-c)/(24*60*60*1e3));l>0&&l<90&&o.push(l)}if(!o.length)return null;const a=Math.round(o.reduce((s,c)=>s+c,0)/o.length),e=n[n.length-1],r=new Date(e);return r.setDate(r.getDate()+a),{dateKey:f(r),avgCycle:a}}function v(){const t=document.getElementById("periodStatus"),n=document.getElementById("periodPrediction"),o=document.getElementById("periodHistoryList"),a=document.getElementById("periodStartBtn"),e=document.getElementById("periodEndBtn");if(!t||!n||!o)return;const r=i.periodRecords,s=O(r);f(new Date),s?(t.innerHTML=`
      <div class="period-status-title">è¿›è¡Œä¸­</div>
      <div>å¼€å§‹ï¼š${y(s.startDate)}</div>
      <div>ç»“æŸï¼šå°šæœªè®°å½•</div>
    `,e&&(e.disabled=!1),a&&(a.disabled=!0)):(t.innerHTML=`
      <div class="period-status-title">æœªåœ¨ç»æœŸ</div>
      <div>è®°å½•ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€å¼€å§‹æ–°å‘¨æœŸ</div>
    `,e&&(e.disabled=!0),a&&(a.disabled=!1));const c=le(r);c?(n.innerHTML=`
      <div class="period-prediction-title">é¢„è®¡ä¸‹æ¬¡å¼€å§‹</div>
      <div class="period-prediction-value">${y(c.dateKey)}</div>
      <div class="period-prediction-hint">åŸºäºå¹³å‡å‘¨æœŸ ${c.avgCycle} å¤©ï¼Œä»…ä¾›å‚è€ƒ</div>
    `,n.hidden=!1):(n.innerHTML=`
      <div class="period-prediction-title">é¢„æµ‹</div>
      <div class="period-prediction-hint">å†è®°å½•è‡³å°‘ 2 æ¬¡ã€Œæ¥çš„ç¬¬ä¸€å¤©ã€åä¼šæ˜¾ç¤ºé¢„æµ‹</div>
    `,n.hidden=!1);const d=[...r].sort((l,u)=>u.startDate>l.startDate?1:-1);if(!d.length){o.innerHTML='<div class="period-empty">æš‚æ— ç»æœŸè®°å½•</div>';return}o.innerHTML="",d.forEach(l=>{const u=document.createElement("div");u.className="period-history-item";const p=l.endDate?`${y(l.startDate)} ï½ ${y(l.endDate)}`:`${y(l.startDate)} ï½ è¿›è¡Œä¸­`,m=l.endDate?Math.round((new Date(l.endDate)-new Date(l.startDate))/(24*60*60*1e3))+1:"";u.innerHTML=`
      <span class="period-range">${p}</span>
      <span class="period-days">${m?m+" å¤©":""}</span>
      <button type="button" class="period-history-delete" data-period-id="${l.id}">åˆ </button>
    `,o.appendChild(u)})}function ue(){i.records=se(),i.periodRecords=de(),j.forEach(e=>{e.addEventListener("click",()=>{j.forEach(r=>r.classList.remove("active")),e.classList.add("active"),i.currentType=e.dataset.type||"fitness",h(i.records,i.filter)})});const t=document.querySelector(".type-tab.active");t&&(i.currentType=t.dataset.type||"fitness"),h(i.records,i.filter),B.addEventListener("click",()=>{const e=new Date,r={id:`${e.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:e.getTime(),dateKey:f(e),type:i.currentType};if(i.records.push(r),N(i.records),h(i.records,i.filter),B.classList.remove("punch-button-bounce"),B.offsetWidth,B.classList.add("punch-button-bounce"),G&&(G.textContent="æ½˜ç§‹ç‘¾çœŸæ£’ï¼"),C&&C.classList.add("show"),A){A.innerHTML="";const s=["â¤","ğŸ’œ","ğŸ’—"],c=32;for(let d=0;d<8;d++){const l=d/8*2*Math.PI-Math.PI/2,u=Math.cos(l)*c,p=Math.sin(l)*c,m=document.createElement("span");m.className="heart-burst",m.textContent=s[d%s.length],m.style.setProperty("--tx",u+"px"),m.style.setProperty("--ty",p+"px"),m.style.setProperty("--delay",d*40+"ms"),A.appendChild(m)}}R&&clearTimeout(R),R=setTimeout(()=>{C&&C.classList.remove("show")},1800)}),q.forEach(e=>{e.addEventListener("click",()=>{q.forEach(r=>r.classList.remove("active")),e.classList.add("active"),i.filter=e.dataset.filter||"all",h(i.records,i.filter)})}),J.forEach(e=>{e.addEventListener("click",()=>{J.forEach(r=>r.classList.remove("active")),e.classList.add("active"),i.historyType=e.dataset.historyType||"all",h(i.records,i.filter)})}),U&&U.addEventListener("click",()=>{w()}),W&&W.addEventListener("click",()=>{if(L){const e=L;L=null,w(),e()}else w()}),g&&g.addEventListener("click",e=>{e.target===g&&w()}),S.addEventListener("click",e=>{const r=e.target;if(!(r instanceof HTMLElement)||!r.classList.contains("time-delete-btn"))return;const s=r.getAttribute("data-id");if(!s)return;const c=i.records.find(u=>u.id===s);if(!c)return;const d=V(c.type||"other"),l=new Date(c.timestamp);T({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${d}ã€‘åœ¨ã€${y(c.dateKey)} ${$(l)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{i.records=i.records.filter(u=>u.id!==s),N(i.records),h(i.records,i.filter)}})}),te.addEventListener("click",()=>{const e=document.getElementById("actionsMenu");if(e&&e.classList.contains("open")&&e.classList.remove("open"),!i.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const r=["ç±»å‹","æ—¥æœŸ","æ—¶é—´","æ—¶é—´æˆ³"],s=i.records.slice().sort((p,m)=>p.timestamp-m.timestamp).map(p=>{const m=new Date(p.timestamp);return[p.type||"other",p.dateKey,$(m),String(p.timestamp)]}),c=[r,...s].map(p=>p.map(m=>`"${m}"`).join(",")).join(`
`),d=new Blob([c],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(d),u=document.createElement("a");u.href=l,u.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${f(new Date)}.csv`,u.click(),URL.revokeObjectURL(l)}),ne.addEventListener("click",()=>{const e=document.getElementById("actionsMenu");e&&e.classList.contains("open")&&e.classList.remove("open"),i.records.length&&T({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{i.records=[],N(i.records),h(i.records,i.filter)}})});const n=document.getElementById("periodStartBtn");n&&n.addEventListener("click",()=>{const e=O(i.periodRecords),r=f(new Date);if(e){const s=new Date;s.setDate(s.getDate()-1);const c=f(s);T({title:"å¼€å§‹æ–°å‘¨æœŸ",message:"å½“å‰æœ‰ä¸€å‘¨æœŸæœªç»“æŸï¼Œå°†æŠŠä¸Šä¸€å‘¨æœŸç»“æŸæ—¥è®¾ä¸ºæ˜¨å¤©ï¼Œå†è®°å½•æœ¬æ¬¡å¼€å§‹ã€‚ç¡®å®šï¼Ÿ",onConfirm:()=>{e.endDate=c;const d={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:r,endDate:null};i.periodRecords.push(d),I(i.periodRecords),v()}})}else{const s={id:`p-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,startDate:r,endDate:null};i.periodRecords.push(s),I(i.periodRecords),v()}});const o=document.getElementById("periodEndBtn");o&&o.addEventListener("click",()=>{const e=O(i.periodRecords);if(!e)return;const r=f(new Date);e.endDate=r,I(i.periodRecords),v()});const a=document.getElementById("periodHistoryList");a&&a.addEventListener("click",e=>{const r=e.target;if(!r.classList.contains("period-history-delete"))return;const s=r.getAttribute("data-period-id");if(!s)return;const c=i.periodRecords.find(l=>l.id===s);if(!c)return;const d=c.endDate?`${y(c.startDate)} ï½ ${y(c.endDate)}`:y(c.startDate)+" ï½ è¿›è¡Œä¸­";T({title:"åˆ é™¤ç»æœŸè®°å½•",message:`ç¡®å®šåˆ é™¤ã€Œ${d}ã€è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{i.periodRecords=i.periodRecords.filter(l=>l.id!==s),I(i.periodRecords),v()}})})}document.addEventListener("DOMContentLoaded",function(){ue(),v();var t=document.getElementById("actionsFabToggle"),n=document.getElementById("actionsMenu");t&&n&&(t.addEventListener("click",function(){n.classList.toggle("open")}),document.addEventListener("click",function(c){n.classList.contains("open")&&!t.contains(c.target)&&!n.contains(c.target)&&n.classList.remove("open")}));var o=document.getElementById("panelPunch"),a=document.getElementById("panelPeriod"),e=document.querySelectorAll(".tab-bar-item"),r=document.getElementById("actionsFab");function s(c){i.activeTab=c,c==="punch"?(o&&(o.classList.add("active"),o.removeAttribute("hidden")),a&&(a.classList.remove("active"),a.hidden=!0),r&&r.classList.remove("tab-period-hidden")):(o&&(o.classList.remove("active"),o.hidden=!0),a&&(a.classList.add("active"),a.removeAttribute("hidden")),r&&r.classList.add("tab-period-hidden"),v()),e.forEach(function(d){d.getAttribute("data-tab")===c?(d.classList.add("active"),d.setAttribute("aria-selected","true")):(d.classList.remove("active"),d.setAttribute("aria-selected","false"))})}e.forEach(function(c){c.addEventListener("click",function(){var d=c.getAttribute("data-tab");d&&s(d)})})});
