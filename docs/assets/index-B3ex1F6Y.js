(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const E=document.getElementById("punchBtn"),z=document.getElementById("todayCount"),Q=document.getElementById("streakCount"),P=document.getElementById("lastPunchTime"),C=document.getElementById("historyList"),H=document.querySelectorAll(".filter-tab"),V=document.getElementById("exportBtn"),X=document.getElementById("clearBtn"),F=document.querySelectorAll(".type-tab"),q=document.querySelectorAll(".history-type-tab"),u=document.getElementById("confirmModal"),Z=document.getElementById("modalTitle"),ee=document.getElementById("modalMessage"),j=document.getElementById("modalCancel"),U=document.getElementById("modalConfirm"),v=document.getElementById("praiseWrap"),W=document.getElementById("praiseText"),k=document.getElementById("praiseHearts"),_="punch_records_v1";function te(){try{const t=localStorage.getItem(_);if(!t)return[];const e=JSON.parse(t);return Array.isArray(e)?e:[]}catch(t){return console.error("Failed to load records",t),[]}}function K(t){localStorage.setItem(_,JSON.stringify(t))}function f(t){return t.toISOString().slice(0,10)}function J(t){const e=new Map;return t.forEach(n=>{e.has(n.dateKey)||e.set(n.dateKey,[]),e.get(n.dateKey).push(n)}),Array.from(e.entries()).sort((n,s)=>n[0]<s[0]?1:-1).map(([n,s])=>({dateKey:n,recs:s}))}function T(t){const e=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),s=String(t.getSeconds()).padStart(2,"0");return`${e}:${n}:${s}`}function N(t){const[e,n,s]=t.split("-");return`${e}å¹´${Number(n)}æœˆ${Number(s)}æ—¥`}function ne(t){const e=f(new Date);return t.filter(n=>n.dateKey===e).length}function oe(t){if(!t.length)return 0;const e=J(t);let n=0,s=new Date,o=f(s);for(let c=0;c<e.length;c++){const{dateKey:i}=e[c];if(i===o)n++,s.setDate(s.getDate()-1),o=f(s);else break}return n}function G(t){switch(t){case"fitness":return"å¥èº«";case"toilet":return"å¦‚å•";case"meal":return"é¥­å¦";default:return"å…¶ä»–"}}function se(t,e){const n=new Date,s=f(n);if(e==="today")return t.filter(o=>o.dateKey===s);if(e==="week"){const o=new Date;o.setDate(n.getDate()-6);const c=f(o);return t.filter(i=>i.dateKey>=c)}if(e==="month"){const[o,c]=s.split("-"),i=`${o}-${c}`;return t.filter(a=>a.dateKey.startsWith(i))}return t}function m(t,e="all"){if(z.textContent=String(ne(t)),Q.textContent=String(oe(t)),!t.length)P.textContent="æš‚æ— æ‰“å¡è®°å½•";else{const i=t[t.length-1],a=new Date(i.timestamp);P.textContent=`æœ€åä¸€æ¬¡ï¼š${N(i.dateKey)} ${T(a)}`}const n=se(t,e);if(C.innerHTML="",!n.length){C.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <p>è¿˜æ²¡æœ‰æ‰“å¡è®°å½•</p>
      </div>
    `;return}const s=document.createDocumentFragment(),o=r.historyType||"all";["toilet","meal","fitness","other"].forEach(i=>{if(o!=="all"&&o!==i)return;const a=n.filter(p=>(p.type||"other")===i);if(!a.length)return;const d=document.createElement("div");d.className=`history-type-block history-type-block-${i}`;const l=document.createElement("div");l.className="history-item";const B=document.createElement("div"),b=document.createElement("div");b.className="history-date",b.textContent=G(i);const w=document.createElement("div");w.className="history-time",w.textContent=`å…± ${a.length} æ¬¡`,B.appendChild(b),B.appendChild(w),l.appendChild(B),d.appendChild(l),J(a.slice().sort((p,I)=>p.timestamp-I.timestamp)).forEach(({dateKey:p,recs:I})=>{const x=document.createElement("div");x.className="history-item";const D=document.createElement("div"),S=document.createElement("div");S.className="history-date",S.textContent=N(p);const M=document.createElement("div");M.className="history-time-list",I.forEach(O=>{const Y=new Date(O.timestamp),h=document.createElement("div");h.className="time-chip";const A=document.createElement("span");A.textContent=T(Y);const g=document.createElement("button");g.className="time-delete-btn",g.textContent="åˆ ",g.setAttribute("data-id",O.id),h.appendChild(A),h.appendChild(g),M.appendChild(h)}),D.appendChild(S),D.appendChild(M),x.appendChild(D),d.appendChild(x)}),s.appendChild(d)}),C.appendChild(s)}let r={records:[],filter:"all",currentType:"fitness",historyType:"all"},y=null,$=null;function R(t){const{title:e,message:n,onConfirm:s}=t;if(!u){window.confirm(n)&&typeof s=="function"&&s();return}Z.textContent=e||"ç¡®è®¤æ“ä½œ",ee.textContent=n||"",y=typeof s=="function"?s:null,u.hidden=!1}function L(){u&&(u.hidden=!0),y=null}function re(){r.records=te(),F.forEach(e=>{e.addEventListener("click",()=>{F.forEach(n=>n.classList.remove("active")),e.classList.add("active"),r.currentType=e.dataset.type||"fitness",m(r.records,r.filter)})});const t=document.querySelector(".type-tab.active");t&&(r.currentType=t.dataset.type||"fitness"),m(r.records,r.filter),E.addEventListener("click",()=>{const e=new Date,n={id:`${e.getTime()}-${Math.random().toString(36).slice(2,6)}`,timestamp:e.getTime(),dateKey:f(e),type:r.currentType};if(r.records.push(n),K(r.records),m(r.records,r.filter),E.classList.remove("punch-button-bounce"),E.offsetWidth,E.classList.add("punch-button-bounce"),W&&(W.textContent="æ½˜ç§‹ç‘¾çœŸæ£’ï¼"),v&&v.classList.add("show"),k){k.innerHTML="";const s=["â¤","ğŸ’œ","ğŸ’—"],o=32;for(let c=0;c<8;c++){const i=c/8*2*Math.PI-Math.PI/2,a=Math.cos(i)*o,d=Math.sin(i)*o,l=document.createElement("span");l.className="heart-burst",l.textContent=s[c%s.length],l.style.setProperty("--tx",a+"px"),l.style.setProperty("--ty",d+"px"),l.style.setProperty("--delay",c*40+"ms"),k.appendChild(l)}}$&&clearTimeout($),$=setTimeout(()=>{v&&v.classList.remove("show")},1800)}),H.forEach(e=>{e.addEventListener("click",()=>{H.forEach(n=>n.classList.remove("active")),e.classList.add("active"),r.filter=e.dataset.filter||"all",m(r.records,r.filter)})}),q.forEach(e=>{e.addEventListener("click",()=>{q.forEach(n=>n.classList.remove("active")),e.classList.add("active"),r.historyType=e.dataset.historyType||"all",m(r.records,r.filter)})}),j&&j.addEventListener("click",()=>{L()}),U&&U.addEventListener("click",()=>{if(y){const e=y;y=null,L(),e()}else L()}),u&&u.addEventListener("click",e=>{e.target===u&&L()}),C.addEventListener("click",e=>{const n=e.target;if(!(n instanceof HTMLElement)||!n.classList.contains("time-delete-btn"))return;const s=n.getAttribute("data-id");if(!s)return;const o=r.records.find(a=>a.id===s);if(!o)return;const c=G(o.type||"other"),i=new Date(o.timestamp);R({title:"åˆ é™¤æ‰“å¡è®°å½•",message:`ç¡®å®šåˆ é™¤ã€${c}ã€‘åœ¨ã€${N(o.dateKey)} ${T(i)}ã€‘çš„è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,onConfirm:()=>{r.records=r.records.filter(a=>a.id!==s),K(r.records),m(r.records,r.filter)}})}),V.addEventListener("click",()=>{const e=document.getElementById("actionsMenu");if(e&&e.classList.contains("open")&&e.classList.remove("open"),!r.records.length){alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");return}const n=["ç±»å‹","æ—¥æœŸ","æ—¶é—´","æ—¶é—´æˆ³"],s=r.records.slice().sort((d,l)=>d.timestamp-l.timestamp).map(d=>{const l=new Date(d.timestamp);return[d.type||"other",d.dateKey,T(l),String(d.timestamp)]}),o=[n,...s].map(d=>d.map(l=>`"${l}"`).join(",")).join(`
`),c=new Blob([o],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(c),a=document.createElement("a");a.href=i,a.download=`æ‰“å¡è®°å½•-å…¨éƒ¨-${f(new Date)}.csv`,a.click(),URL.revokeObjectURL(i)}),X.addEventListener("click",()=>{const e=document.getElementById("actionsMenu");e&&e.classList.contains("open")&&e.classList.remove("open"),r.records.length&&R({title:"æ¸…ç©ºæ‰€æœ‰è®°å½•",message:"ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",onConfirm:()=>{r.records=[],K(r.records),m(r.records,r.filter)}})})}document.addEventListener("DOMContentLoaded",function(){re();var t=document.getElementById("actionsFabToggle"),e=document.getElementById("actionsMenu");t&&e&&(t.addEventListener("click",function(){e.classList.toggle("open")}),document.addEventListener("click",function(n){e.classList.contains("open")&&!t.contains(n.target)&&!e.contains(n.target)&&e.classList.remove("open")}))});
